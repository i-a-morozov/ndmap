<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example-01: Derivative &mdash; ndtorch  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Util" href="../modules/util.html" />
    <link rel="prev" title="Welcome to ndtorch’s documentation!" href="../index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            ndtorch
              <img src="../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Examples:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example-01: Derivative</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-02:-Derivative-table-representation">Example-02: Derivative table representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-03:-Derivative-table-propagation">Example-03: Derivative table propagation</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-04:-Jet-class">Example-04: Jet class</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-05:-Nonlinear-mapping-approximation">Example-05: Nonlinear mapping approximation</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-06:-Fixed-point">Example-06: Fixed point</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-07:-Parametric-fixed-point">Example-07: Parametric fixed point</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-08:-Fixed-point-manipulation-(collision)">Example-08: Fixed point manipulation (collision)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-09:-Fixed-point-manipulation-(change-point-type)">Example-09: Fixed point manipulation (change point type)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-10:-Alignment-indices-chaos-indicators">Example-10: Alignment indices chaos indicators</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-11:-Closed-orbit-(dispersion)">Example-11: Closed orbit (dispersion)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-12:-Closed-orbit-(quadrupole-shift)">Example-12: Closed orbit (quadrupole shift)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-13:-Closed-orbit-(sextupole-shift)">Example-13: Closed orbit (sextupole shift)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-14:-Closed-orbit-(responce-matrix-&amp;-correction)">Example-14: Closed orbit (responce matrix &amp; correction)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-15:-Tune-(chromaticity)">Example-15: Tune (chromaticity)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-16:-Tune-(responce-matrix-&amp;-correction)">Example-16: Tune (responce matrix &amp; correction)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-17:-Tune-(spread)">Example-17: Tune (spread)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-18:-Parametric-twiss">Example-18: Parametric twiss</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-19:-Parametric-phase-advance">Example-19: Parametric phase advance</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-20:-Poisson-bracket">Example-20: Poisson bracket</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-21:-Taylor-integrator">Example-21: Taylor integrator</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-22:-Yoshida-integrator">Example-22: Yoshida integrator</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-23:-Direct-invariant">Example-23: Direct invariant</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-24:-Direct-invariant-(parametric)">Example-24: Direct invariant (parametric)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-25:-Composition">Example-25: Composition</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-26:-Composition-(closed-orbit)">Example-26: Composition (closed orbit)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-27:-Inverse">Example-27: Inverse</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-28:-Inverse-(closed-orbit)">Example-28: Inverse (closed orbit)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-29:-Momenta-generator">Example-29: Momenta generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-30:-Factorization-(kick)">Example-30: Factorization (kick)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-31:-Factorization-(fodo)">Example-31: Factorization (fodo)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-32:-Factorization-(factorize)">Example-32: Factorization (factorize)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-33:-Nonlinear-mapping-approximation-(gradient)">Example-33: Nonlinear mapping approximation (gradient)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-34:-ORM-optics-correction">Example-34: ORM optics correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-35:-ORM-optics-correction-(stochastic-objective)">Example-35: ORM optics correction (stochastic objective)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html">Util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html#ndtorch.util.curry_apply"><code class="docutils literal notranslate"><span class="pre">curry_apply()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html#ndtorch.util.first"><code class="docutils literal notranslate"><span class="pre">first()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html#ndtorch.util.flatten"><code class="docutils literal notranslate"><span class="pre">flatten()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html#ndtorch.util.last"><code class="docutils literal notranslate"><span class="pre">last()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html#ndtorch.util.most"><code class="docutils literal notranslate"><span class="pre">most()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html#ndtorch.util.multinomial"><code class="docutils literal notranslate"><span class="pre">multinomial()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html#ndtorch.util.nest"><code class="docutils literal notranslate"><span class="pre">nest()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html#ndtorch.util.orthogonal"><code class="docutils literal notranslate"><span class="pre">orthogonal()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html#ndtorch.util.rest"><code class="docutils literal notranslate"><span class="pre">rest()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html#ndtorch.util.symplectic"><code class="docutils literal notranslate"><span class="pre">symplectic()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html#ndtorch.util.tolist"><code class="docutils literal notranslate"><span class="pre">tolist()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/derivative.html">Derivative</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/derivative.html#ndtorch.derivative.derivative"><code class="docutils literal notranslate"><span class="pre">derivative()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html">Gradient</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.derivative"><code class="docutils literal notranslate"><span class="pre">derivative()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.evaluate"><code class="docutils literal notranslate"><span class="pre">evaluate()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.factor"><code class="docutils literal notranslate"><span class="pre">factor()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.group"><code class="docutils literal notranslate"><span class="pre">group()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.hessian"><code class="docutils literal notranslate"><span class="pre">hessian()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.index"><code class="docutils literal notranslate"><span class="pre">index()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.jacobian"><code class="docutils literal notranslate"><span class="pre">jacobian()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.naught"><code class="docutils literal notranslate"><span class="pre">naught()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.reduce"><code class="docutils literal notranslate"><span class="pre">reduce()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.scalar"><code class="docutils literal notranslate"><span class="pre">scalar()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.select"><code class="docutils literal notranslate"><span class="pre">select()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.series"><code class="docutils literal notranslate"><span class="pre">series()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.signature"><code class="docutils literal notranslate"><span class="pre">signature()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/gradient.html#ndtorch.gradient.split"><code class="docutils literal notranslate"><span class="pre">split()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/complex.html">Complex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/signature.html">Signature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/signature.html#ndtorch.signature.apply"><code class="docutils literal notranslate"><span class="pre">apply()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/signature.html#ndtorch.signature.chop"><code class="docutils literal notranslate"><span class="pre">chop()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/signature.html#ndtorch.signature.get"><code class="docutils literal notranslate"><span class="pre">get()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/signature.html#ndtorch.signature.set"><code class="docutils literal notranslate"><span class="pre">set()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/signature.html#ndtorch.signature.signature"><code class="docutils literal notranslate"><span class="pre">signature()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/signature.html#ndtorch.signature.to"><code class="docutils literal notranslate"><span class="pre">to()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html#ndtorch.index.build"><code class="docutils literal notranslate"><span class="pre">build()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html#ndtorch.index.index"><code class="docutils literal notranslate"><span class="pre">index()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html#ndtorch.index.reduce"><code class="docutils literal notranslate"><span class="pre">reduce()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/series.html">Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/series.html#ndtorch.series.clean"><code class="docutils literal notranslate"><span class="pre">clean()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/series.html#ndtorch.series.fetch"><code class="docutils literal notranslate"><span class="pre">fetch()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/series.html#ndtorch.series.merge"><code class="docutils literal notranslate"><span class="pre">merge()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/series.html#ndtorch.series.series"><code class="docutils literal notranslate"><span class="pre">series()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/series.html#ndtorch.series.split"><code class="docutils literal notranslate"><span class="pre">split()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/evaluate.html">Evaluate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/evaluate.html#ndtorch.evaluate.compare"><code class="docutils literal notranslate"><span class="pre">compare()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/evaluate.html#ndtorch.evaluate.evaluate"><code class="docutils literal notranslate"><span class="pre">evaluate()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/evaluate.html#ndtorch.evaluate.table"><code class="docutils literal notranslate"><span class="pre">table()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/propagate.html">Propagate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/propagate.html#ndtorch.propagate.identity"><code class="docutils literal notranslate"><span class="pre">identity()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/propagate.html#ndtorch.propagate.propagate"><code class="docutils literal notranslate"><span class="pre">propagate()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/pfp.html">Parametric fixed point</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/pfp.html#ndtorch.pfp.chain_point"><code class="docutils literal notranslate"><span class="pre">chain_point()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/pfp.html#ndtorch.pfp.check_point"><code class="docutils literal notranslate"><span class="pre">check_point()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/pfp.html#ndtorch.pfp.clean_point"><code class="docutils literal notranslate"><span class="pre">clean_point()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/pfp.html#ndtorch.pfp.fixed_point"><code class="docutils literal notranslate"><span class="pre">fixed_point()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/pfp.html#ndtorch.pfp.matrix"><code class="docutils literal notranslate"><span class="pre">matrix()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/pfp.html#ndtorch.pfp.newton"><code class="docutils literal notranslate"><span class="pre">newton()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/pfp.html#ndtorch.pfp.parametric_fixed_point"><code class="docutils literal notranslate"><span class="pre">parametric_fixed_point()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/bracket.html">Bracket</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/bracket.html#ndtorch.bracket.bracket"><code class="docutils literal notranslate"><span class="pre">bracket()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/taylor.html">Taylor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/taylor.html#ndtorch.taylor.taylor"><code class="docutils literal notranslate"><span class="pre">taylor()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/yoshida.html">Yoshida</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/yoshida.html#ndtorch.yoshida.coefficients"><code class="docutils literal notranslate"><span class="pre">coefficients()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/yoshida.html#ndtorch.yoshida.yoshida"><code class="docutils literal notranslate"><span class="pre">yoshida()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/invariant.html">Invariant</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/invariant.html#ndtorch.invariant.invariant"><code class="docutils literal notranslate"><span class="pre">invariant()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/inverse.html">Inverse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/inverse.html#ndtorch.inverse.inverse"><code class="docutils literal notranslate"><span class="pre">inverse()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/momenta.html">Momenta</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/momenta.html#ndtorch.momenta.momenta"><code class="docutils literal notranslate"><span class="pre">momenta()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/factorization.html">Factorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/factorization.html#ndtorch.factorization.factorize"><code class="docutils literal notranslate"><span class="pre">factorize()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/factorization.html#ndtorch.factorization.hamiltonian"><code class="docutils literal notranslate"><span class="pre">hamiltonian()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/factorization.html#ndtorch.factorization.hamiltonian_inverse"><code class="docutils literal notranslate"><span class="pre">hamiltonian_inverse()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/factorization.html#ndtorch.factorization.solution"><code class="docutils literal notranslate"><span class="pre">solution()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/jet.html">Jet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/jet.html#ndtorch.jet.Jet"><code class="docutils literal notranslate"><span class="pre">Jet</span></code></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ndtorch</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Example-01: Derivative</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/ndtorch.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Example-01:-Derivative">
<h1>Example-01: Derivative<a class="headerlink" href="#Example-01:-Derivative" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given an input function, its higher order (partial) derivatives with respect to one or sevaral tensor arguments can be computed using forward or reverse mode automatic differentiation</span>
<span class="c1"># Derivative orders can be different for each tensor argument</span>
<span class="c1"># Input function is expected to return a tensor or a (nested) list of tensors</span>

<span class="c1"># Derivatives are computed by nesting torch jacobian functions</span>
<span class="c1"># For higher order derivatives, nesting results in exponentially growing redundant computations</span>
<span class="c1"># Note, forward mode is more memory efficient in this case</span>

<span class="c1"># If the input function returns a tensor, the output is referred as derivative table representation</span>
<span class="c1"># This representation can be evaluated near given evaluation point (at a given deviation) if the input function returns a scalar or a vector</span>
<span class="c1"># Table representation is a (nested) list of tensors, it can be used as a redundant function representation near given evaluation point (taylor series)</span>
<span class="c1"># Table structure for f(x), f(x, y) and f(x, y, z) is shown bellow (similar structure holds for a function with more aruments)</span>

<span class="c1"># f(x)</span>
<span class="c1"># t(f, x)</span>
<span class="c1"># [f, Dx f, Dxx f, ...]</span>

<span class="c1"># f(x, y)</span>
<span class="c1"># t(f, x, y)</span>
<span class="c1"># [</span>
<span class="c1">#     [    f,     Dy f,     Dyy f, ...],</span>
<span class="c1">#     [ Dx f,  Dx Dy f,  Dx Dyy f, ...],</span>
<span class="c1">#     [Dxx f, Dxx Dy f, Dxx Dyy f, ...],</span>
<span class="c1">#     ...</span>
<span class="c1"># ]</span>

<span class="c1"># f(x, y, z)</span>
<span class="c1"># t(f, x, y, z)</span>
<span class="c1"># [</span>
<span class="c1">#     [</span>
<span class="c1">#         [         f,          Dz f,          Dzz f, ...],</span>
<span class="c1">#         [      Dy f,       Dy Dz f,       Dy Dzz f, ...],</span>
<span class="c1">#         [     Dyy f,      Dyy Dz f,      Dyy Dzz f, ...],</span>
<span class="c1">#         ...</span>
<span class="c1">#     ],</span>
<span class="c1">#     [</span>
<span class="c1">#         [      Dx f,       Dx Dz f,       Dx Dzz f, ...],</span>
<span class="c1">#         [   Dx Dy f,    Dx Dy Dz f,    Dx Dy Dzz f, ...],</span>
<span class="c1">#         [  Dx Dyy f,   Dx Dyy Dz f,   Dx Dyy Dzz f, ...],</span>
<span class="c1">#         ...</span>
<span class="c1">#     ],</span>
<span class="c1">#     [</span>
<span class="c1">#         [    Dxx f,     Dxx Dz f,     Dxx Dzz f, ...],</span>
<span class="c1">#         [ Dxx Dy f,  Dxx Dy Dz f,  Dxx Dy Dzz f, ...],</span>
<span class="c1">#         [Dxx Dyy f, Dxx Dyy Dz f, Dxx Dyy Dzz f, ...],</span>
<span class="c1">#         ...</span>
<span class="c1">#     ],</span>
<span class="c1">#     ...</span>
<span class="c1"># ]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic derivative interface</span>

<span class="c1"># derivative(</span>
<span class="c1">#     order:int,                             # derivative order</span>
<span class="c1">#     function:Callable,                     # input function</span>
<span class="c1">#     *args,                                 # function(*args) = function(x:Tensor, ...)</span>
<span class="c1">#     intermediate:bool = True,              # flag to return all intermediate derivatives</span>
<span class="c1">#     jacobian:Callable = torch.func.jacfwd  # torch.func.jacfwd or torch.func.jacfrev</span>
<span class="c1"># )</span>

<span class="c1"># derivative(</span>
<span class="c1">#     order:tuple[int, ...],                 # derivative orders</span>
<span class="c1">#     function:Callable,                     # input function</span>
<span class="c1">#     *args,                                 # function(*args) = function(x:Tensor, y:Tensor, z:Tensor, ...)</span>
<span class="c1">#     intermediate:bool = True,              # flag to return all intermediate derivatives</span>
<span class="c1">#     jacobian:Callable = torch.func.jacfwd  # torch.func.jacfwd or torch.func.jacfrev</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Derivative</span>

<span class="c1"># Input:  scalar</span>
<span class="c1"># Output: scalar</span>

<span class="c1"># Set test function</span>

<span class="c1"># Note, the first function argument is a scalar tensor</span>
<span class="c1"># Input function can have other additional arguments</span>
<span class="c1"># Other arguments are not used in computation of derivatives</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">d</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">e</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="n">f</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">5</span>

<span class="c1"># Set derivative order</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Set fixed parameters</span>

<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute n&#39;th derivative</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="c1"># Compute all derivatives upto given order</span>

<span class="c1"># Note, function value itself is referred as zero order derivative</span>
<span class="c1"># Since function returns a tensor, output is a list of tensors</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>

<span class="c1"># Note, intermediate flag (default=True) can be used to return all derivatives</span>
<span class="c1"># For jacobian parameter, torch.func.jacfwd or torch.func.jacrev functions can be passed</span>

<span class="c1"># Evaluate derivative table representation for a given deviation from the evaluation point</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
120.0
1.0, 1.0, 2.0, 6.0, 24.0, 120.0
6.0
6.0
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Derivative</span>

<span class="c1"># Input:  vector</span>
<span class="c1"># Output: scalar</span>

<span class="c1"># Set test function</span>

<span class="c1"># Note, the first function argument is a vector tensor</span>
<span class="c1"># Input function can have other additional arguments</span>
<span class="c1"># Other arguments are not used in computation of derivatives</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">x2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<span class="c1"># Set derivative order</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Set fixed parameters</span>

<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute only n&#39;th derivative</span>

<span class="c1"># Note, for given input &amp; output the result is a hessian</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="c1"># Compute all derivatives upto given order</span>

<span class="c1"># Note, fuction value itself is referred as zero order derivative</span>
<span class="c1"># Output is a list of tensors (value, jacobian, hessian, ...)</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>

<span class="c1"># Compute jacobian and hessian with torch</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
      <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
      <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
      <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>

<span class="c1"># Evaluate derivative table representation for a given deviation from the evaluation point</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">+</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

<span class="c1"># Evaluate can be mapped over a set of deviation values</span>

<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]))(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="p">[</span><span class="n">dx</span><span class="p">]))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="c1"># Derivative can be mapped over a set of evaluation points</span>

<span class="c1"># Note, the inputt function is expeted to return a tensor</span>

<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[2.0, 0.0], [0.0, 2.0]]
3.0, [-2.0, 2.0], [[2.0, 0.0], [0.0, 2.0]]
3.0, [-2.0, 2.0], [[2.0, 0.0], [0.0, 2.0]]
1.0
1.0
[1.0, 1.0, 1.0, 1.0, 1.0]
[[-2.0, 2.0], [-2.0, 2.0], [-2.0, 2.0], [-2.0, 2.0], [-2.0, 2.0]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Derivative</span>

<span class="c1"># Input:  vector</span>
<span class="c1"># Output: vector</span>

<span class="c1"># Set test function</span>

<span class="c1"># Note, the first function argument is a vector tensor</span>
<span class="c1"># Input function can have other additional arguments</span>
<span class="c1"># Other arguments (if any) are not used in computation of derivatives</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">X1</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">x1</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">x2</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">x1</span> <span class="o">+</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">x2</span>
    <span class="n">X3</span> <span class="o">=</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">x1</span> <span class="o">+</span> <span class="mf">6.0</span><span class="o">*</span><span class="n">x2</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">X3</span><span class="p">])</span>

<span class="c1"># Set derivative order</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute derivatives</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Evaluate derivative table representation for a given deviation from the evaluation point</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0.0, 0.0, 0.0], [[1.0, 2.0], [3.0, 4.0], [5.0, 6.0]]

[-1.0, -1.0, -1.0]
[-1.0, -1.0, -1.0]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Derivative</span>

<span class="c1"># Input:  tensor</span>
<span class="c1"># Output: tensor</span>

<span class="c1"># Set test function</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span>

<span class="c1"># Set derivative order</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute derivatives</span>

<span class="c1"># Note, output is a list of tensors</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Evaluate derivative table representation for a given deviation from the evaluation point</span>

<span class="c1"># Note, evaluate function works with scalar or vector tensor input</span>
<span class="c1"># One should compute derivatives of a wrapped function and reshape the result of evaluate</span>

<span class="c1"># Set wrapped function</span>

<span class="k">def</span> <span class="nf">gn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gn</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="c1"># Compute derivatives</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">gn</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Set deviation value</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Evaluate</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gn</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1, 2, 3]
[1, 2, 3, 1, 2, 3]
[1, 2, 3, 1, 2, 3, 1, 2, 3]
[1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3]
[[[1.0, 1.0, 1.0], [1.0, 1.0, 1.0]]]
[[[1.0, 1.0, 1.0], [1.0, 1.0, 1.0]]]
[[[4.0, 4.0, 4.0], [4.0, 4.0, 4.0]]]
[[[4.0, 4.0, 4.0], [4.0, 4.0, 4.0]]]
[[[4.0, 4.0, 4.0], [4.0, 4.0, 4.0]]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Derivative</span>

<span class="c1"># Input:  vector</span>
<span class="c1"># Output: nested list of tensors</span>

<span class="c1"># Set test function</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="n">x6</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">X1</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">x1</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">x2</span> <span class="o">+</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">x3</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">x4</span> <span class="o">+</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">x5</span> <span class="o">+</span> <span class="mf">6.0</span><span class="o">*</span><span class="n">x6</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">X1</span><span class="p">]),</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">X2</span><span class="p">])]]</span>

<span class="c1"># Set derivative order</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute derivatives</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Derivative</span>

<span class="c1"># Input:  vector, vector, vector</span>
<span class="c1"># Output: vector</span>

<span class="c1"># Set test function</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span>
    <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">z</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y1</span> <span class="o">+</span> <span class="n">y2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">z1</span> <span class="o">+</span> <span class="n">z2</span><span class="p">)])</span>

<span class="c1"># Set derivative orders for x, y and z</span>

<span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>

<span class="c1"># Set evaluation point</span>
<span class="c1"># Note, evaluation point is a list of tensors</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute n&#39;th derivativ</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">),</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="c1"># Compute all derivatives upto given order</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">),</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Evaluate derivative table representation for a given deviation from the evaluation point</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">dy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">dz</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">dz</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="c1"># Note, if the input function has vector arguments and returns a tensor, it can be repsented with series</span>

<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">series</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">),</span> <span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[[[1.0, 1.0], [1.0, 1.0]], [[1.0, 1.0], [1.0, 1.0]]]]
[8.0]
[8.0]
(0, 0, 0, 0, 0, 0): [0.0]
(0, 0, 0, 0, 1, 0): [0.0]
(0, 0, 0, 0, 0, 1): [0.0]
(0, 0, 1, 0, 0, 0): [0.0]
(0, 0, 0, 1, 0, 0): [0.0]
(0, 0, 1, 0, 1, 0): [0.0]
(0, 0, 1, 0, 0, 1): [0.0]
(0, 0, 0, 1, 1, 0): [0.0]
(0, 0, 0, 1, 0, 1): [0.0]
(1, 0, 0, 0, 0, 0): [0.0]
(0, 1, 0, 0, 0, 0): [0.0]
(1, 0, 0, 0, 1, 0): [0.0]
(1, 0, 0, 0, 0, 1): [0.0]
(0, 1, 0, 0, 1, 0): [0.0]
(0, 1, 0, 0, 0, 1): [0.0]
(1, 0, 1, 0, 0, 0): [0.0]
(1, 0, 0, 1, 0, 0): [0.0]
(0, 1, 1, 0, 0, 0): [0.0]
(0, 1, 0, 1, 0, 0): [0.0]
(1, 0, 1, 0, 1, 0): [1.0]
(1, 0, 1, 0, 0, 1): [1.0]
(1, 0, 0, 1, 1, 0): [1.0]
(1, 0, 0, 1, 0, 1): [1.0]
(0, 1, 1, 0, 1, 0): [1.0]
(0, 1, 1, 0, 0, 1): [1.0]
(0, 1, 0, 1, 1, 0): [1.0]
(0, 1, 0, 1, 0, 1): [1.0]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Redundancy free computation</span>

<span class="c1"># Set test function</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="mf">1.0</span><span class="o">*</span><span class="n">x1</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">x2</span> <span class="o">+</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">x1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">x1</span><span class="o">*</span><span class="n">x2</span> <span class="o">+</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">x2</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>

<span class="c1"># Set derivative order</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute n&#39;th derivative</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="c1"># Since derivatives are computed by nesting of jacobian function, redundant computations appear starting from the second order</span>
<span class="c1"># Redundant computations can be avoided if all input arguments are scalar tensors</span>

<span class="k">def</span> <span class="nf">gn</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">]))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">gn</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">gn</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">gn</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[[6.0, 4.0], [4.0, 10.0]]]
[6.0]
[4.0]
[10.0]
</pre></div></div>
</div>
</section>
<section id="Example-02:-Derivative-table-representation">
<h1>Example-02: Derivative table representation<a class="headerlink" href="#Example-02:-Derivative-table-representation" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Input function f: R^n x R^m x ... -&gt; R^n is referred as a mapping</span>
<span class="c1"># The first function argument is state, other arguments (used in computation of derivatives) and knobs</span>
<span class="c1"># State and all knobs are vector-like tensors</span>
<span class="c1"># Note, functions of this form can be used to model tranformations throught accelerator magnets</span>

<span class="c1"># In this case, derivatives can be used to generate a (parametric) model of the input function</span>
<span class="c1"># Function model can be represented as a derivative table or coefficients of monomials (series representation)</span>

<span class="c1"># In this example, table representation is used to model transformation throught a sextupole accelerator magnet</span>
<span class="c1"># Table is computed with respect to state variables (phase space variables) and knobs (magnet strength and length)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">signature</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">get</span>
<span class="kn">from</span> <span class="nn">ndtorch.index</span> <span class="kn">import</span> <span class="n">index</span>
<span class="kn">from</span> <span class="nn">ndtorch.index</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">ndtorch.index</span> <span class="kn">import</span> <span class="n">build</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mapping (sextupole accelerator magnet transformatijet)</span>
<span class="c1"># Given initial state, magnet strength and length, state is propagated using explicit symplectic integration</span>
<span class="c1"># Number of integration steps is set by count parameter, integration step length is length/count</span>

<span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">count</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Table representation (state)</span>

<span class="c1"># Set evaluation point &amp; parameters</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">10.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute derivatives (table representation)</span>
<span class="c1"># Since derivatives are computed only with respect to the state, output table is a list of tensors</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">t</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
torch.Size([4])
torch.Size([4, 4])
torch.Size([4, 4, 4])
torch.Size([4, 4, 4, 4])
torch.Size([4, 4, 4, 4, 4])
torch.Size([4, 4, 4, 4, 4, 4])
torch.Size([4, 4, 4, 4, 4, 4, 4])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare table and exact mapping near the evaluation point (change order to observe convergence)</span>
<span class="c1"># Note, table transformation is not symplectic</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mapping</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0.00010000041624970626, 0.0010000066749862018, 0.00010000016750044096, 5.000018166514047e-09]
[0.0001000004162497062, 0.0010000066749862018, 0.00010000016750044096, 5.000018166514046e-09]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Each bottom element (tensor) in the (flattend) derivative table is assosiated with a signature</span>
<span class="c1"># Signature is a tuple of derivative orders</span>

<span class="nb">print</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(0,), (1,), (2,), (3,), (4,), (5,), (6,)]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For a given signature, corresponding element can be extracted or changed with get/set functions</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[1.  0.1 0.  0. ]
 [0.  1.  0.  0. ]
 [0.  0.  1.  0.1]
 [0.  0.  0.  1. ]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Each bottom element is related to monomials</span>
<span class="c1"># For given order, monomial indices with repetitions can be computed</span>
<span class="c1"># These repetitions account for evaluation of the same partial derivatives with diffenent orders, e.g. df/dxdy vs df/dydx</span>

<span class="nb">print</span><span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[2 0 0 0]
 [1 1 0 0]
 [1 0 1 0]
 [1 0 0 1]
 [1 1 0 0]
 [0 2 0 0]
 [0 1 1 0]
 [0 1 0 1]
 [1 0 1 0]
 [0 1 1 0]
 [0 0 2 0]
 [0 0 1 1]
 [1 0 0 1]
 [0 1 0 1]
 [0 0 1 1]
 [0 0 0 2]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Explicit evaluation</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">((</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">6</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span> <span class="o">@</span> <span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">((</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">6</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">@</span> <span class="n">dx</span><span class="p">)</span> <span class="o">@</span> <span class="n">dx</span><span class="p">)</span> <span class="o">@</span> <span class="n">dx</span><span class="p">)</span> <span class="o">@</span> <span class="n">dx</span><span class="p">)</span> <span class="o">@</span> <span class="n">dx</span><span class="p">)</span> <span class="o">@</span> <span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1.00000416e-04 1.00000667e-03 1.00000168e-04 5.00001817e-09]
[1.00000416e-04 1.00000667e-03 1.00000168e-04 5.00001817e-09]
[1.00000416e-04 1.00000667e-03 1.00000168e-04 5.00001817e-09]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Series representation can be generated from a given table</span>
<span class="c1"># This representation stores monomial powers and corresponding coefficients</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">s</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">s</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">s</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">s</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[1.  0.  0.  0. ]
 [0.1 1.  0.  0. ]
 [0.  0.  1.  0. ]
 [0.  0.  0.1 1. ]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Evaluate series</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1.00000416e-04 1.00000667e-03 1.00000168e-04 5.00001817e-09]
[1.00000416e-04 1.00000667e-03 1.00000168e-04 5.00001817e-09]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Table representation (state &amp; knobs)</span>

<span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">10.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute derivatives (table representation)</span>
<span class="c1"># Since derivatives are computed with respect to state and knobs, output table is a nested list of tensors</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this case, bottom table element signature is a tuple with several integers</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[1.  0.1 0.  0. ]
 [0.  1.  0.  0. ]
 [0.  0.  1.  0.1]
 [0.  0.  0.  1. ]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare table and exact mapping near evaluation point (change order to observe convergence)</span>
<span class="c1"># Note, table transofrmation is not symplectic</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">dk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">dl</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">dk</span><span class="p">,</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">dl</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">dk</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">dl</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mapping</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">dk</span><span class="p">,</span> <span class="n">l</span> <span class="o">+</span> <span class="n">dl</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0.00010000041624970626, 0.0010000066749862018, 0.00010000016750044096, 5.000018166514047e-09]
[0.0001010004271286862, 0.001000006741987918, 0.00010000017425071835, 5.1510191197368185e-09]
[0.00010100042712809422, 0.0010000067409770773, 0.00010000017430164039, 5.151524128394736e-09]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Each bottom element (tensor) in the (flattend) derivative table is assosiated with a signature</span>
<span class="c1"># Signature is a tuple of derivative orders</span>

<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">signature</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(0, 0, 0)
(0, 0, 1)
(0, 1, 0)
(0, 1, 1)
(1, 0, 0)
(1, 0, 1)
(1, 1, 0)
(1, 1, 1)
(2, 0, 0)
(2, 0, 1)
(2, 1, 0)
(2, 1, 1)
(3, 0, 0)
(3, 0, 1)
(3, 1, 0)
(3, 1, 1)
(4, 0, 0)
(4, 0, 1)
(4, 1, 0)
(4, 1, 1)
(5, 0, 0)
(5, 0, 1)
(5, 1, 0)
(5, 1, 1)
(6, 0, 0)
(6, 0, 1)
(6, 1, 0)
(6, 1, 1)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute series</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">t</span><span class="p">)</span>

<span class="c1"># Keys are generalized monomials</span>

<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Evaluate series</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dk</span><span class="p">,</span> <span class="n">dl</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dk</span><span class="p">,</span> <span class="n">dl</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1.447578e-06 9.756747e-05 0.000000e+00 0.000000e+00]

[1.01000427e-04 1.00000674e-03 1.00000174e-04 5.15101912e-09]
[1.01000427e-04 1.00000674e-03 1.00000174e-04 5.15101912e-09]

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reduced table representation</span>

<span class="n">sequence</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">t</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
<span class="n">build</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">unique</span><span class="p">)</span>
<span class="n">compare</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
</section>
<section id="Example-03:-Derivative-table-propagation">
<h1>Example-03: Derivative table propagation<a class="headerlink" href="#Example-03:-Derivative-table-propagation" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given a mapping f(state, *knobs, ...) and a derivative table t, derivatives of f(t, *knobs, ...) are computed</span>
<span class="c1"># This can be used to propagate derivative table throught a given mapping (computation of parametric fixed points and other applications)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define mappings</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">ring</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Direct</span>

<span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute derivatives</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">ring</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

<span class="c1"># Evaluate for a given deviation</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">dw</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ring</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">w</span> <span class="o">+</span> <span class="n">dw</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dw</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[-8.88568650e-05 -5.43957672e-05  4.97569694e-04 -1.40349102e-04]
[-8.88568650e-05 -5.43957672e-05  4.97569694e-04 -1.40349102e-04]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagation</span>

<span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Set identity table</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span>

<span class="c1"># Propagate table</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">quad</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">drif</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">quad</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">quad</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">drif</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">quad</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Evaluate for a given deviation</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">dw</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ring</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">w</span> <span class="o">+</span> <span class="n">dw</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dw</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[-8.88568650e-05 -5.43957672e-05  4.97569694e-04 -1.40349102e-04]
[-8.88568650e-05 -5.43957672e-05  4.97569694e-04 -1.40349102e-04]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Series representation</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">clean</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">t</span><span class="p">))</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1, 0, 0, 0, 0): [-0.09072843 -0.05430498  0.          0.        ]
(0, 1, 0, 0, 0): [18.26293553 -0.09072843  0.          0.        ]
(0, 0, 1, 0, 0): [ 0.          0.          0.49625858 -0.14063034]
(0, 0, 0, 1, 0): [0.         0.         5.35963583 0.49625858]
(1, 0, 0, 0, 1): [ 1.87420951 -0.09097396  0.          0.        ]
(0, 1, 0, 0, 1): [-24.33227046   1.87420951   0.           0.        ]
(0, 0, 1, 0, 1): [0.         0.         1.31324305 0.28161167]
(0, 0, 0, 1, 1): [0.         0.         1.46426265 1.31324305]
(1, 0, 0, 0, 2): [-2.65007558  0.18727838  0.          0.        ]
(0, 1, 0, 0, 2): [30.20570906 -2.65007558  0.          0.        ]
(0, 0, 1, 0, 2): [ 0.          0.         -2.12812904 -0.37146989]
(0, 0, 0, 1, 2): [ 0.          0.         -8.46895909 -2.12812904]
(1, 0, 0, 0, 3): [ 3.41796043 -0.28459189  0.          0.        ]
(0, 1, 0, 0, 3): [-35.88102956   3.41796043   0.           0.        ]
(0, 0, 1, 0, 3): [0.         0.         2.94802229 0.46018886]
(0, 0, 0, 1, 3): [ 0.          0.         15.6516443   2.94802229]
(1, 0, 0, 0, 4): [-4.17749922  0.38289808  0.          0.        ]
(0, 1, 0, 0, 4): [41.3560843  -4.17749922  0.          0.        ]
(0, 0, 1, 0, 4): [ 0.          0.         -3.77254434 -0.54775243]
(0, 0, 0, 1, 4): [  0.           0.         -23.00943634  -3.77254434]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check invariant</span>
<span class="c1"># Note, ring has two quadratic invariants (actions), zeros are padded to match state length</span>

<span class="c1"># Define invariant</span>

<span class="n">matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">4.282355639365032</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.23351633638449415</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.484643367729646</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.40247224732044934</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">invariant</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span> <span class="o">@</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">px</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">qy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">py</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)])</span>

<span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Evaluate invarint for a given state and transformed state</span>

<span class="nb">print</span><span class="p">(</span><span class="n">invariant</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">invariant</span><span class="p">(</span><span class="n">ring</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[2.72649397e-08 8.09919549e-08 0.00000000e+00 0.00000000e+00]
[2.72649397e-08 8.09919549e-08 0.00000000e+00 0.00000000e+00]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Invariant propagation</span>

<span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute table and series representations of invariant</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">invariant</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">clean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0E-14</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Compute table and series representations of transformed invariant</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">invariant</span><span class="p">(</span><span class="n">ring</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)),</span> <span class="n">x</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">clean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0E-14</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Propagate invariant</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">ring</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[],</span> <span class="n">invariant</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">clean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0E-14</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(2, 0, 0, 0): [0.02726494 0.         0.         0.        ]
(0, 2, 0, 0): [9.16928491 0.         0.         0.        ]
(0, 0, 2, 0): [0.         0.08099195 0.         0.        ]
(0, 0, 0, 2): [0.         3.08672633 0.         0.        ]

(2, 0, 0, 0): [0.02726494 0.         0.         0.        ]
(0, 2, 0, 0): [9.16928491 0.         0.         0.        ]
(0, 0, 2, 0): [0.         0.08099195 0.         0.        ]
(0, 0, 0, 2): [0.         3.08672633 0.         0.        ]

(2, 0, 0, 0): [0.02726494 0.         0.         0.        ]
(0, 2, 0, 0): [9.16928491 0.         0.         0.        ]
(0, 0, 2, 0): [0.         0.08099195 0.         0.        ]
(0, 0, 0, 2): [0.         3.08672633 0.         0.        ]

</pre></div></div>
</div>
</section>
<section id="Example-04:-Jet-class">
<h1>Example-04: Jet class<a class="headerlink" href="#Example-04:-Jet-class" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Jet is a convenience class to work with jets (evaluation point &amp; derivative table)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.jet</span> <span class="kn">import</span> <span class="n">Jet</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define mappings</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute table representation</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">quad</span><span class="p">(</span><span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">w</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set jet</span>

<span class="n">j</span> <span class="o">=</span> <span class="n">Jet</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">point</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">drif</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">quad</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Evaluate at given deviation</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">dw</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dw</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">j</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="n">dw</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[ 0.0005005 -0.001      0.0014995  0.001    ]
[ 0.0005005 -0.001      0.0014995  0.001    ]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Composition</span>

<span class="n">j1</span> <span class="o">=</span> <span class="n">Jet</span><span class="o">.</span><span class="n">from_mapping</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span> <span class="n">drif</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">j2</span> <span class="o">=</span> <span class="n">Jet</span><span class="o">.</span><span class="n">from_mapping</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span> <span class="n">quad</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">((</span><span class="n">j1</span> <span class="o">@</span> <span class="n">j2</span><span class="p">)([</span><span class="n">dx</span><span class="p">,</span> <span class="n">dw</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[ 0.0005005 -0.001      0.0014995  0.001    ]
</pre></div></div>
</div>
</section>
<section id="Example-05:-Nonlinear-mapping-approximation">
<h1>Example-05: Nonlinear mapping approximation<a class="headerlink" href="#Example-05:-Nonlinear-mapping-approximation" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Composition of several nonlinear mappings can be approximated by its table representation</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set test mapping</span>
<span class="c1"># Rotation with two sextupoles separated by negative identity linear transformation</span>
<span class="c1"># Note, result is expected to have zero degree two coefficients due to negative identity linear transformation between sextupoles</span>

<span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="o">*</span><span class="n">mux</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">px</span><span class="o">*</span><span class="n">mux</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">px</span><span class="o">*</span><span class="n">mux</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">qx</span><span class="o">*</span><span class="n">mux</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">qy</span><span class="o">*</span><span class="n">muy</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">py</span><span class="o">*</span><span class="n">muy</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">py</span><span class="o">*</span><span class="n">muy</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">qy</span><span class="o">*</span><span class="n">muy</span><span class="o">.</span><span class="n">sin</span><span class="p">()])</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">ring</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">spin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">spin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute derivative table</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># Compute and print series</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">clean</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">),</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0E-12</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">clean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0E-14</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1, 0, 0, 0): [0.55339155 0.83292124 0.         0.        ]
(0, 1, 0, 0): [-0.83292124  0.55339155  0.          0.        ]
(0, 0, 1, 0): [0.         0.         0.06279052 0.99802673]
(0, 0, 0, 1): [ 0.          0.         -0.99802673  0.06279052]
(3, 0, 0, 0): [-7.53257307e-09  2.82424677e-03  0.00000000e+00  0.00000000e+00]
(2, 1, 0, 0): [-1.96250238e-08 -1.27525063e-02  0.00000000e+00  0.00000000e+00]
(2, 0, 1, 0): [ 0.00000000e+00 -0.00000000e+00  9.21186111e-06  3.34331441e-04]
(2, 0, 0, 1): [ 0.00000000e+00 -0.00000000e+00  1.59704766e-05 -5.06941449e-03]
(1, 2, 0, 0): [-1.11004920e-08  1.91940679e-02  0.00000000e+00  0.00000000e+00]
(1, 1, 1, 0): [ 0.00000000e+00 -0.00000000e+00 -2.98671134e-05 -9.79459005e-04]
(1, 1, 0, 1): [ 0.00000000e+00 -0.00000000e+00 -1.48185697e-05  1.53623878e-02]
(1, 0, 2, 0): [-1.05857397e-06  1.97282603e-05  0.00000000e+00  0.00000000e+00]
(1, 0, 1, 1): [ 1.48154798e-05 -1.18570682e-03  0.00000000e+00  0.00000000e+00]
(1, 0, 0, 2): [2.88067554e-05 9.18409783e-03 0.00000000e+00 0.00000000e+00]
(0, 3, 0, 0): [-9.21338044e-10 -9.62979589e-03  0.00000000e+00  0.00000000e+00]
(0, 2, 1, 0): [ 0.00000000e+00 -0.00000000e+00  2.40366928e-05  7.09979811e-04]
(0, 2, 0, 1): [ 0.00000000e+00 -0.00000000e+00 -1.38786549e-05 -1.15294375e-02]
(0, 1, 2, 0): [ 1.80396305e-06 -2.59196622e-05  0.00000000e+00  0.00000000e+00]
(0, 1, 1, 1): [-2.98509155e-05  1.72488752e-03  0.00000000e+00  0.00000000e+00]
(0, 1, 0, 2): [ 1.66318846e-05 -1.38269522e-02  0.00000000e+00  0.00000000e+00]
(0, 0, 3, 0): [ 0.00000000e+00 -0.00000000e+00 -1.47704279e-08  4.12534350e-06]
(0, 0, 2, 1): [ 0.00000000e+00 -0.00000000e+00 -3.31103168e-09 -1.96719688e-04]
(0, 0, 1, 2): [ 0.00000000e+00 -0.00000000e+00  3.93325786e-09  3.12683573e-03]
(0, 0, 0, 3): [ 0.00000000e+00 -0.00000000e+00  2.56887204e-10 -1.65665408e-02]
(4, 0, 0, 0): [ 6.48869023e-07 -3.91844462e-06  0.00000000e+00  0.00000000e+00]
(3, 1, 0, 0): [-3.91685700e-06  1.51001133e-05  0.00000000e+00  0.00000000e+00]
(3, 0, 1, 0): [ 0.00000000e+00 -0.00000000e+00 -4.36165465e-07  5.76316391e-06]
(3, 0, 0, 1): [ 0.00000000e+00 -0.00000000e+00  6.56410859e-06  1.31668166e-05]
(2, 2, 0, 0): [ 8.85501662e-06 -1.48880894e-05  0.00000000e+00  0.00000000e+00]
(2, 1, 1, 0): [ 0.00000000e+00 -0.00000000e+00  1.92232731e-06 -2.78183189e-05]
(2, 1, 0, 1): [ 0.00000000e+00 -0.00000000e+00 -2.96894787e-05 -3.16635607e-05]
(2, 0, 2, 0): [1.81838643e-08 2.18816315e-06 0.00000000e+00 0.00000000e+00]
(2, 0, 1, 1): [-9.93314202e-07 -3.25277215e-05  0.00000000e+00  0.00000000e+00]
(2, 0, 0, 2): [ 7.67316422e-06 -2.51871510e-05  0.00000000e+00  0.00000000e+00]
(1, 3, 0, 0): [-8.88618620e-06 -4.33921249e-06  0.00000000e+00  0.00000000e+00]
(1, 2, 1, 0): [ 0.00000000e+00 -0.00000000e+00 -2.81910856e-06  4.44963121e-05]
(1, 2, 0, 1): [ 0.00000000e+00 -0.00000000e+00  4.47107608e-05  6.22767407e-06]
(1, 1, 2, 0): [-5.02653030e-08 -6.69892371e-06  0.00000000e+00  0.00000000e+00]
(1, 1, 1, 1): [2.90625131e-06 1.04277202e-04 0.00000000e+00 0.00000000e+00]
(1, 1, 0, 2): [-2.28808176e-05  2.60346923e-05  0.00000000e+00  0.00000000e+00]
(1, 0, 3, 0): [ 0.00000000e+00 -0.00000000e+00  2.09236592e-09  3.51323891e-08]
(1, 0, 2, 1): [ 0.00000000e+00 -0.00000000e+00 -6.41657941e-09 -1.78350571e-06]
(1, 0, 1, 2): [ 0.00000000e+00 -0.00000000e+00 -6.10954936e-07  1.86435774e-05]
(1, 0, 0, 3): [ 0.00000000e+00 -0.00000000e+00  3.05503037e-06 -5.00150901e-05]
(0, 4, 0, 0): [3.33982092e-06 8.88114110e-06 0.00000000e+00 0.00000000e+00]
(0, 3, 1, 0): [ 0.00000000e+00 -0.00000000e+00  1.37553970e-06 -2.36217768e-05]
(0, 3, 0, 1): [ 0.00000000e+00 -0.00000000e+00 -2.24184174e-05  1.77513110e-05]
(0, 2, 2, 0): [3.54703897e-08 5.11986525e-06 0.00000000e+00 0.00000000e+00]
(0, 2, 1, 1): [-2.15414781e-06 -8.31702815e-05  0.00000000e+00  0.00000000e+00]
(0, 2, 0, 2): [1.72952174e-05 1.78791226e-05 0.00000000e+00 0.00000000e+00]
(0, 1, 3, 0): [ 0.00000000e+00 -0.00000000e+00 -3.32576455e-09 -2.16775859e-08]
(0, 1, 2, 1): [ 0.00000000e+00 -0.00000000e+00  1.73891518e-08  1.32003603e-06]
(0, 1, 1, 2): [ 0.00000000e+00 -0.00000000e+00  8.58583303e-07 -7.35197022e-06]
(0, 1, 0, 3): [ 0.00000000e+00 -0.00000000e+00 -4.60205741e-06 -3.44817289e-05]
(0, 0, 4, 0): [-2.95410616e-10 -3.91436795e-10  0.00000000e+00  0.00000000e+00]
(0, 0, 3, 1): [ 1.72261161e-08 -3.76703368e-08  0.00000000e+00  0.00000000e+00]
(0, 0, 2, 2): [-3.76632244e-07  1.04173914e-06  0.00000000e+00  0.00000000e+00]
(0, 0, 1, 3): [ 3.81179356e-06 -5.44741177e-06  0.00000000e+00  0.00000000e+00]
(0, 0, 0, 4): [-1.51552013e-05 -3.46854944e-07  0.00000000e+00  0.00000000e+00]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare phase space trajectories</span>
<span class="c1"># Note, change order to observe convergence</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Direct tracking</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)]])</span><span class="o">.</span><span class="n">T</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ring</span><span class="p">(</span><span class="n">x</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">table</span>

<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qx</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">px</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Table tracking</span>
<span class="c1"># Note, table representation is not symplectic</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)]])</span><span class="o">.</span><span class="n">T</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]))(</span><span class="n">x</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">table</span>

<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qx</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">px</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_55_0.png" src="../_images/examples_ndtorch_55_0.png" />
</div>
</div>
</section>
<section id="Example-06:-Fixed-point">
<h1>Example-06: Fixed point<a class="headerlink" href="#Example-06:-Fixed-point" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this example fixed points are computed for a simple symplectic nonlinear transformation</span>
<span class="c1"># Fixed point are computed with Newton root search</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">clean_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">chain_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">matrix</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set forward &amp; inverse mappings</span>

<span class="n">mu</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">ko</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="o">*</span><span class="n">mu</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">mu</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">p</span><span class="o">*</span><span class="n">mu</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">mu</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">kq</span><span class="o">*</span><span class="n">q</span> <span class="o">+</span> <span class="n">ks</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ko</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="n">kq</span><span class="o">*</span><span class="n">q</span> <span class="o">+</span> <span class="n">ks</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ko</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="o">*</span><span class="n">mu</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">mu</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">p</span><span class="o">*</span><span class="n">mu</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">q</span><span class="o">*</span><span class="n">mu</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute period three fixed points</span>

<span class="c1"># Set fixed point period</span>

<span class="n">period</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># Set tolerance epsilon</span>

<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.0E-12</span>

<span class="c1"># Set random initial points</span>

<span class="n">points</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span>

<span class="c1"># Perform 512 root search iterations for each initial point</span>

<span class="n">points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">forward</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">))(</span><span class="n">points</span><span class="p">)</span>

<span class="c1"># Clean points (remove nans, duplicates, points from the same chain)</span>

<span class="n">points</span> <span class="o">=</span> <span class="n">clean_point</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">forward</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>

<span class="c1"># Generate fixed point chains</span>

<span class="n">chains</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">chain_point</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">forward</span><span class="p">,</span> <span class="n">point</span><span class="p">))(</span><span class="n">points</span><span class="p">)</span>

<span class="c1"># Classify fixed point chains (elliptic vs hyperbolic)</span>
<span class="c1"># Generate initials for hyperbolic fixed points using corresponding eigenvectors</span>

<span class="n">kinds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
    <span class="n">point</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>
    <span class="n">values</span><span class="p">,</span> <span class="n">vectors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">forward</span><span class="p">,</span> <span class="n">point</span><span class="p">))</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">)</span>
    <span class="n">kinds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kind</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span> <span class="o">+</span> <span class="n">vector</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">epsilon</span><span class="p">,</span> <span class="o">+</span><span class="n">epsilon</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">vector</span> <span class="ow">in</span> <span class="n">vectors</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># Plot phase space</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qs</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">table</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ps</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plot (approximated) stable and unstable  manifolds of hyperbolic fixed points</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">310</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">qs</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">table</span>
    <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ps</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">inverse</span><span class="p">(</span><span class="n">x</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">qs</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">table</span>
    <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ps</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plot chains</span>

<span class="k">for</span> <span class="n">chain</span><span class="p">,</span> <span class="n">kind</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="n">kinds</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">chain</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span><span class="s1">&#39;red&#39;</span><span class="p">}[</span><span class="n">kind</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_61_0.png" src="../_images/examples_ndtorch_61_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set mapping around elliptic fixed point</span>

<span class="n">point</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="n">kinds</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">point</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">period</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">point</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="c1"># Test mapping</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="c1"># Plot phase space</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qs</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">table</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ps</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qs</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">table</span> <span class="o">+</span> <span class="n">point</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ps</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0.], dtype=torch.float64)
tensor([-1.110223024625e-16,  0.000000000000e+00], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_62_1.png" src="../_images/examples_ndtorch_62_1.png" />
</div>
</div>
</section>
<section id="Example-07:-Parametric-fixed-point">
<h1>Example-07: Parametric fixed point<a class="headerlink" href="#Example-07:-Parametric-fixed-point" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given a mapping depending on a set of knobs (parameters), parametric fixed points can be computed (position of a fixed point as function of parameters)</span>
<span class="c1"># Parametric fixed points can be used to construct responce matrices, e.g. closed orbit responce</span>
<span class="c1"># In this case only first order derivatives of the fixed point(s) with respect to parameters are computed</span>
<span class="c1"># Or higher order expansions can be computed</span>
<span class="c1"># In this example parametric fixed points of a symplectic mapping are computed</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.util</span> <span class="kn">import</span> <span class="n">flatten</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">clean_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">chain_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">matrix</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set mapping</span>

<span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="o">*</span><span class="n">mu</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">mu</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">p</span><span class="o">*</span><span class="n">mu</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">mu</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute dynamical fixed points</span>
<span class="c1"># Note, fixed point might fail due to escape to large values</span>

<span class="c1"># Set parameters</span>

<span class="n">mu</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">5</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute and plot phase space trajectories</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qs</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">table</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ps</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Set tolerance epsilon</span>

<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.0E-12</span>

<span class="c1"># Compute chains</span>

<span class="n">period</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">))(</span><span class="n">points</span><span class="p">)</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">clean_point</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
<span class="n">chains</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">chain_point</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">k</span><span class="p">))(</span><span class="n">points</span><span class="p">)</span>

<span class="c1"># Plot chains</span>

<span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
    <span class="n">point</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">chain</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;blue&#39;</span><span class="p">:</span>
        <span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hp</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_68_0.png" src="../_images/examples_ndtorch_68_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute hyperbolic fixed point for a set of knobs</span>

<span class="n">dks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

<span class="n">fps</span> <span class="o">=</span> <span class="p">[</span><span class="n">hp</span><span class="p">]</span>
<span class="k">for</span> <span class="n">dk</span> <span class="ow">in</span> <span class="n">dks</span><span class="p">:</span>
    <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">initial</span> <span class="o">=</span> <span class="n">fps</span>
    <span class="n">fps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">dk</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">))</span>

<span class="n">fps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">fps</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric fixed point</span>

<span class="c1"># Set computation order</span>
<span class="c1"># Note, change order to observe convergence</span>

<span class="n">order</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="p">),</span> <span class="n">hp</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>

<span class="c1"># Set period mapping and check fixed point propagation</span>

<span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">period</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">function</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="nb">list</span><span class="p">),</span> <span class="n">flatten</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="nb">list</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
True
True
True
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot parametric fixed point position for a given set of knobs</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dk</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">hp</span><span class="p">,</span> <span class="n">dk</span><span class="p">]))(</span><span class="n">dks</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">fps</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">out</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_71_0.png" src="../_images/examples_ndtorch_71_0.png" />
</div>
</div>
</section>
<section id="Example-08:-Fixed-point-manipulation-(collision)">
<h1>Example-08: Fixed point manipulation (collision)<a class="headerlink" href="#Example-08:-Fixed-point-manipulation-(collision)" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this example the distance between a pair of hyperbolic and elliptic fixed points is minimized</span>
<span class="c1"># First, using a set of initial guesses within a region, a pair is obtained</span>
<span class="c1"># For a given pair, first order parametric dependence of fixed point positions is computed</span>
<span class="c1"># Gradient of the distance function between the points is computed (GD minimization)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">clean_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">chain_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">matrix</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set mapping</span>

<span class="n">limit</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">phase</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="mf">0.005</span><span class="p">)</span>
<span class="n">phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">phase</span><span class="o">/</span><span class="p">(</span><span class="n">limit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">knobs</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">state</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">limit</span><span class="p">):</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">p</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">knobs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">p</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Locate fixed points and select a pair</span>

<span class="c1"># Set initial knobs</span>

<span class="n">knobs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">limit</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute and plot phase space trajectories</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">state</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">state</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))(</span><span class="n">state</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qs</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">table</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ps</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Set tolerance epsilon</span>

<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.0E-12</span>

<span class="c1"># Compute chains</span>

<span class="n">period</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">points</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">))(</span><span class="n">points</span><span class="p">)</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">clean_point</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
<span class="n">chains</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">chain_point</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))(</span><span class="n">points</span><span class="p">)</span>

<span class="c1"># Plot chains</span>

<span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
    <span class="n">point</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">chain</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;blue&#39;</span><span class="p">:</span>
        <span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hp</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>

<span class="n">ep_chain</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span> <span class="k">if</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span>
<span class="n">hp_chain</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span> <span class="k">if</span> <span class="n">hp</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span>

<span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">ep_chain</span>
<span class="n">hp</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">hp_chain</span><span class="p">[(</span><span class="n">ep</span> <span class="o">-</span> <span class="n">hp_chain</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">ep</span> <span class="o">-</span> <span class="n">hp_chain</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">hp</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ep</span><span class="p">,</span> <span class="n">hp</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_77_0.png" src="../_images/examples_ndtorch_77_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute first order parametric fixed points</span>

<span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">php</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="p">),</span> <span class="n">hp</span><span class="p">,</span> <span class="p">[</span><span class="n">knobs</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
<span class="n">pep</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="p">),</span> <span class="n">ep</span><span class="p">,</span> <span class="p">[</span><span class="n">knobs</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set objective function</span>

<span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">knobs</span><span class="p">,</span> <span class="n">php</span><span class="p">,</span> <span class="n">pep</span><span class="p">):</span>
    <span class="n">dhp</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">php</span><span class="p">,</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">knobs</span><span class="p">),</span> <span class="n">knobs</span><span class="p">])</span>
    <span class="n">dep</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">pep</span><span class="p">,</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">knobs</span><span class="p">),</span> <span class="n">knobs</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dep</span> <span class="o">-</span> <span class="n">dhp</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set learning rate and update knobs</span>

<span class="n">lr</span> <span class="o">=</span> <span class="mf">0.0025</span>
<span class="n">gradient</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">php</span><span class="p">,</span> <span class="n">pep</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">knobs</span> <span class="o">-=</span> <span class="n">lr</span><span class="o">*</span><span class="n">gradient</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Iterate</span>

<span class="c1"># Set number of iterations</span>

<span class="n">nitr</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Loop</span>

<span class="k">for</span> <span class="n">intr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nitr</span><span class="p">):</span>

    <span class="c1"># Compute and plot phase space trajectories</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">state</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">state</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))(</span><span class="n">state</span><span class="p">)</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">qs</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">table</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ps</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Find fixed points near previous values</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">hp</span><span class="p">,</span> <span class="n">ep</span><span class="p">])</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">))(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">clean_point</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
    <span class="n">chains</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">chain_point</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))(</span><span class="n">points</span><span class="p">)</span>

    <span class="c1"># Plot chains and selected pair</span>

    <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
        <span class="n">point</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>
        <span class="n">value</span><span class="p">,</span> <span class="n">vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">chain</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;blue&#39;</span><span class="p">:</span>
            <span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hp</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>

    <span class="n">ep_chain</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span> <span class="k">if</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span>
    <span class="n">hp_chain</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span> <span class="k">if</span> <span class="n">hp</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span>

    <span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">ep_chain</span>
    <span class="n">hp</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">hp_chain</span><span class="p">[(</span><span class="n">ep</span> <span class="o">-</span> <span class="n">hp_chain</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">ep</span> <span class="o">-</span> <span class="n">hp_chain</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">hp</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ep</span><span class="p">,</span> <span class="n">hp</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Recompute parametric fixed points</span>
    <span class="c1"># Note,  not strictly necessary to do at each iteration</span>

    <span class="n">php</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="p">),</span> <span class="n">hp</span><span class="p">,</span> <span class="p">[</span><span class="n">knobs</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
    <span class="n">pep</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="p">),</span> <span class="n">ep</span><span class="p">,</span> <span class="p">[</span><span class="n">knobs</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>

    <span class="c1"># Update</span>

    <span class="n">lr</span> <span class="o">*=</span> <span class="mf">2.0</span>
    <span class="n">gradient</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">php</span><span class="p">,</span> <span class="n">pep</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">knobs</span> <span class="o">-=</span> <span class="n">lr</span><span class="o">*</span><span class="n">gradient</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_81_0.png" src="../_images/examples_ndtorch_81_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_81_1.png" src="../_images/examples_ndtorch_81_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_81_2.png" src="../_images/examples_ndtorch_81_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_81_3.png" src="../_images/examples_ndtorch_81_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_81_4.png" src="../_images/examples_ndtorch_81_4.png" />
</div>
</div>
</section>
<section id="Example-09:-Fixed-point-manipulation-(change-point-type)">
<h1>Example-09: Fixed point manipulation (change point type)<a class="headerlink" href="#Example-09:-Fixed-point-manipulation-(change-point-type)" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this example real parts of the eigenvalues of a hyperbolic fixed point are minimized</span>
<span class="c1"># First, using a set of initial guesses within a region, a hyperbolic point is located</span>
<span class="c1"># Parametric fixed point is computed and propagated</span>
<span class="c1"># Propagated table is used as a surrogate model to generate differentible objective</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.util</span> <span class="kn">import</span> <span class="n">nest</span>
<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">clean_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">chain_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">matrix</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set mapping</span>

<span class="n">limit</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">phase</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="mf">0.005</span><span class="p">)</span>
<span class="n">phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">phase</span><span class="o">/</span><span class="p">(</span><span class="n">limit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">knobs</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">state</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">limit</span><span class="p">):</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">p</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">knobs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">p</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Locate fixed points and select a pair</span>

<span class="c1"># Set initial knobs</span>

<span class="n">knobs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">limit</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute and plot phase space trajectories</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">state</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">state</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))(</span><span class="n">state</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qs</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">table</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ps</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Set tolerance epsilon</span>

<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.0E-12</span>

<span class="c1"># Compute chains</span>

<span class="n">period</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">points</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">))(</span><span class="n">points</span><span class="p">)</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">clean_point</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
<span class="n">chains</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">chain_point</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))(</span><span class="n">points</span><span class="p">)</span>

<span class="c1"># Plot chains</span>

<span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
    <span class="n">point</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">chain</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;blue&#39;</span><span class="p">:</span>
        <span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hp</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>

<span class="n">ep_chain</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span> <span class="k">if</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span>
<span class="n">hp_chain</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span> <span class="k">if</span> <span class="n">hp</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span>

<span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">ep_chain</span>
<span class="n">hp</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">hp_chain</span><span class="p">[(</span><span class="n">ep</span> <span class="o">-</span> <span class="n">hp_chain</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">ep</span> <span class="o">-</span> <span class="n">hp_chain</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">hp</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_87_0.png" src="../_images/examples_ndtorch_87_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Matrix around (dynamical) fixed points</span>
<span class="c1"># Note, eigenvalues of a hyperbolic fixed point are not on the unit circle</span>

<span class="n">em</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">knobs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">em</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">em</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">hm</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">knobs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">hm</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">hm</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[2.739351528140e-01, -1.149307994931e+00],
        [5.971467208895e-01, 1.145141455240e+00]], dtype=torch.float64)
tensor([-1.784726318725e-15, -1.784726318725e-15], dtype=torch.float64)

tensor([[1.251182357765e+00, 1.288812994113e-01],
        [1.428760927086e-01, 8.139613303868e-01]], dtype=torch.float64)
tensor([2.545448611841e-01, -2.545448611841e-01], dtype=torch.float64)

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute first order parametric fixed points</span>

<span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">php</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="p">),</span> <span class="n">hp</span><span class="p">,</span> <span class="p">[</span><span class="n">knobs</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
<span class="n">pep</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="p">),</span> <span class="n">ep</span><span class="p">,</span> <span class="p">[</span><span class="n">knobs</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric identity table</span>
<span class="c1"># Note, propagated table can be used as a surrogate model around (parametric) fixed point</span>
<span class="c1"># Here it is used to compute parametric matrix around fixed point and its egenvalues</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="n">hp</span><span class="p">,</span> <span class="n">knobs</span><span class="p">],</span> <span class="n">parametric</span><span class="o">=</span><span class="n">php</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">limit</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">knobs</span><span class="p">],</span> <span class="n">nest</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set objective function</span>

<span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">knobs</span><span class="p">):</span>
    <span class="n">hm</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">hp</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">hm</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initial objective value</span>

<span class="nb">print</span><span class="p">(</span><span class="n">objective</span><span class="p">(</span><span class="n">knobs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor(5.090897223682e-01, dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Objective gradient</span>

<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([-1.974190541982e-01, -4.137846718749e-01, -5.970747283789e-01, -7.018818743275e-01,
        -7.018818743275e-01, -5.970747283789e-01, -4.137846718749e-01, -1.974190541982e-01],
       dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set learning rate and update knobs</span>

<span class="n">lr</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">gradient</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">knobs</span> <span class="o">-=</span> <span class="n">lr</span><span class="o">*</span><span class="n">gradient</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Iterate</span>

<span class="c1"># Set number of iterations</span>

<span class="n">nitr</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Loop</span>

<span class="k">for</span> <span class="n">intr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nitr</span><span class="p">):</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">state</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">state</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))(</span><span class="n">state</span><span class="p">)</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">qs</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">table</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ps</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Set tolerance epsilon</span>

    <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.0E-12</span>

    <span class="c1"># Compute chains</span>

    <span class="n">period</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">hp</span><span class="p">,</span> <span class="n">ep</span><span class="p">])</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">))(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">clean_point</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
    <span class="n">chains</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">chain_point</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))(</span><span class="n">points</span><span class="p">)</span>

    <span class="c1"># Plot chains</span>

    <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
        <span class="n">point</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>
        <span class="n">value</span><span class="p">,</span> <span class="n">vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">chain</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;blue&#39;</span><span class="p">:</span>
            <span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hp</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">chain</span>

    <span class="n">ep_chain</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span> <span class="k">if</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span>
    <span class="n">hp_chain</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span> <span class="k">if</span> <span class="n">hp</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">]</span>

    <span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">ep_chain</span>
    <span class="n">hp</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">hp_chain</span><span class="p">[(</span><span class="n">ep</span> <span class="o">-</span> <span class="n">hp_chain</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">ep</span> <span class="o">-</span> <span class="n">hp_chain</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">hp</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">objective</span><span class="p">(</span><span class="n">knobs</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

    <span class="c1"># Compute parametric fixed points</span>

    <span class="n">php</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="p">),</span> <span class="n">hp</span><span class="p">,</span> <span class="p">[</span><span class="n">knobs</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
    <span class="n">pep</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="p">),</span> <span class="n">ep</span><span class="p">,</span> <span class="p">[</span><span class="n">knobs</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>

    <span class="c1"># Propagate parametric fixed points</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="n">hp</span><span class="p">,</span> <span class="n">knobs</span><span class="p">],</span> <span class="n">parametric</span><span class="o">=</span><span class="n">php</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">limit</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">knobs</span><span class="p">],</span> <span class="n">nest</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">knobs</span><span class="p">))</span>

    <span class="c1"># Update</span>

    <span class="n">lr</span> <span class="o">+=</span> <span class="mf">0.005</span>
    <span class="n">gradient</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">knobs</span> <span class="o">=</span> <span class="n">knobs</span> <span class="o">-</span> <span class="n">lr</span><span class="o">*</span><span class="n">gradient</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_95_0.png" src="../_images/examples_ndtorch_95_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.4875424149522949
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_95_2.png" src="../_images/examples_ndtorch_95_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.44253915640171704
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_95_4.png" src="../_images/examples_ndtorch_95_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.3947019262885917
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_95_6.png" src="../_images/examples_ndtorch_95_6.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.34869831355705994
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_95_8.png" src="../_images/examples_ndtorch_95_8.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.3054166976781556
</pre></div></div>
</div>
</section>
<section id="Example-10:-Alignment-indices-chaos-indicators">
<h1>Example-10: Alignment indices chaos indicators<a class="headerlink" href="#Example-10:-Alignment-indices-chaos-indicators" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set fixed parameters</span>

<span class="n">a1</span><span class="p">,</span> <span class="n">b1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
<span class="n">a2</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>

<span class="n">f1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">0.38</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">f2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">0.41</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">cf1</span><span class="p">,</span> <span class="n">sf1</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">cos</span><span class="p">(),</span> <span class="n">f1</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
<span class="n">cf2</span><span class="p">,</span> <span class="n">sf2</span> <span class="o">=</span> <span class="n">f2</span><span class="o">.</span><span class="n">cos</span><span class="p">(),</span> <span class="n">f2</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set 4D symplectic mapping</span>

<span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">q1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
        <span class="n">b1</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span> <span class="o">+</span> <span class="p">(</span><span class="n">q1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q2</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">sf1</span> <span class="o">+</span> <span class="n">q1</span><span class="o">*</span><span class="p">(</span><span class="n">cf1</span> <span class="o">+</span> <span class="n">a1</span><span class="o">*</span><span class="n">sf1</span><span class="p">),</span>
        <span class="o">-</span><span class="p">((</span><span class="n">q1</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">a1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sf1</span><span class="p">)</span><span class="o">/</span><span class="n">b1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span> <span class="o">+</span> <span class="p">(</span><span class="n">q1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q2</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">cf1</span> <span class="o">-</span> <span class="n">a1</span><span class="o">*</span><span class="n">sf1</span><span class="p">),</span>
        <span class="n">q2</span><span class="o">*</span><span class="n">cf2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p2</span><span class="o">*</span><span class="n">b2</span> <span class="o">+</span> <span class="n">q2</span><span class="o">*</span><span class="p">(</span><span class="n">a2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">q1</span><span class="o">*</span><span class="n">b2</span><span class="p">))</span><span class="o">*</span><span class="n">sf2</span><span class="p">,</span>
        <span class="o">-</span><span class="p">((</span><span class="n">q2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">a2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sf2</span><span class="p">)</span><span class="o">/</span><span class="n">b2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">q1</span><span class="o">*</span><span class="n">q2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">cf2</span> <span class="o">-</span> <span class="n">a2</span><span class="o">*</span><span class="n">sf2</span><span class="p">)</span>
    <span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set 4D symplectic mapping with tangent dynamics</span>

<span class="k">def</span> <span class="nf">tangent</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">vs</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">vs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">m</span> <span class="o">@</span> <span class="n">v</span><span class="p">)(</span><span class="n">vs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">vs</span><span class="o">/</span><span class="n">vs</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set generalized alignment indices computation</span>

<span class="c1"># Note, if number if vectors is equal to two, the index tends towards zero for regular orbits</span>
<span class="c1"># And tends towards a constant value for chaotic motion</span>
<span class="c1"># If the number of vectors is greater than two, index tends towards zero for all cases</span>
<span class="c1"># But for chaotic orbits, zero is reached (exponentialy) faster</span>

<span class="k">def</span> <span class="nf">gali</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0E-12</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">threshold</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svdvals</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span><span class="o">.</span><span class="n">log10</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># First, consider two initial conditions (regular and chaotic)</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.50000</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">orbit</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">orbit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">orbit</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.68925</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">orbit</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">orbit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">orbit</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_103_0.png" src="../_images/examples_ndtorch_103_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute and plot the last gali index at each iteration</span>
<span class="c1"># Note, running minimum is appended at each iteration</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.50000</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">vs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">vs</span> <span class="o">=</span> <span class="n">tangent</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">vs</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">gali</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">),</span> <span class="n">out</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.68925</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">vs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">vs</span> <span class="o">=</span> <span class="n">tangent</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">vs</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">gali</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">),</span> <span class="n">out</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_104_0.png" src="../_images/examples_ndtorch_104_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute indicator using all avaliable vectors for a grid of initial conditions</span>

<span class="k">def</span> <span class="nf">gali</span><span class="p">(</span><span class="n">vs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svdvals</span><span class="p">(</span><span class="n">vs</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">())</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>

<span class="c1"># Set grid</span>

<span class="n">n1</span> <span class="o">=</span> <span class="mi">501</span>
<span class="n">n2</span> <span class="o">=</span> <span class="mi">501</span>

<span class="n">q1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">q2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">+</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">qs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="mf">1.0E-10</span><span class="p">)</span>

<span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">qs</span><span class="p">,</span> <span class="n">ps</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

<span class="n">vs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">qs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">p2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Set tast</span>
<span class="c1"># Perform 512 iterations, compute min of indicator value over the next 64 iterations</span>

<span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">1.0E-10</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">qs</span><span class="p">,</span> <span class="n">vs</span> <span class="o">=</span> <span class="n">tangent</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">vs</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total</span><span class="p">):</span>
        <span class="n">qs</span><span class="p">,</span> <span class="n">vs</span> <span class="o">=</span> <span class="n">tangent</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">vs</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gali</span><span class="p">(</span><span class="n">vs</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">level</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">norm</span><span class="p">()))</span><span class="o">.</span><span class="n">log10</span><span class="p">()</span>

<span class="c1"># Compute and clean data</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">task</span><span class="p">)(</span><span class="n">qs</span><span class="p">,</span> <span class="n">vs</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">neginf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">out</span><span class="p">[(</span><span class="n">out</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">out</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span>
<span class="n">out</span><span class="p">[</span><span class="n">out</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nan</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span>

<span class="c1"># Plot</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">out</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="n">vmin</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span>
    <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_105_0.png" src="../_images/examples_ndtorch_105_0.png" />
</div>
</div>
</section>
<section id="Example-11:-Closed-orbit-(dispersion)">
<h1>Example-11: Closed orbit (dispersion)<a class="headerlink" href="#Example-11:-Closed-orbit-(dispersion)" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this example derivatives of closed orbit with respect to momentum deviation are computed</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>
<span class="c1"># Note, here observation poins are locations between elements, lattice start and lattice end</span>
<span class="c1"># An observable (closed orbit) is computed at observation points</span>

<span class="c1"># All maps are expected to have identical signature of differentible parameters</span>
<span class="c1"># State and momentum deviation in this example</span>
<span class="c1"># But each map can have any number of additional args and kwargs after required parameters</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_02_03</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_03_04</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_04_05</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_05_06</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_06_07</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_07_08</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_08_09</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_09_10</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_10_11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_11_12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_12_13</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_13_14</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_14_15</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_15_16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_16_17</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_17_18</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">map_18_19</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>

<span class="n">transport</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">map_01_02</span><span class="p">,</span>
    <span class="n">map_02_03</span><span class="p">,</span>
    <span class="n">map_03_04</span><span class="p">,</span>
    <span class="n">map_04_05</span><span class="p">,</span>
    <span class="n">map_05_06</span><span class="p">,</span>
    <span class="n">map_06_07</span><span class="p">,</span>
    <span class="n">map_07_08</span><span class="p">,</span>
    <span class="n">map_08_09</span><span class="p">,</span>
    <span class="n">map_09_10</span><span class="p">,</span>
    <span class="n">map_10_11</span><span class="p">,</span>
    <span class="n">map_11_12</span><span class="p">,</span>
    <span class="n">map_12_13</span><span class="p">,</span>
    <span class="n">map_13_14</span><span class="p">,</span>
    <span class="n">map_14_15</span><span class="p">,</span>
    <span class="n">map_15_16</span><span class="p">,</span>
    <span class="n">map_16_17</span><span class="p">,</span>
    <span class="n">map_17_18</span><span class="p">,</span>
    <span class="n">map_18_19</span>
<span class="p">]</span>

<span class="c1"># Define one-turn transport</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The first step is to compute dynamical fixed point</span>

<span class="c1"># Set initial guess</span>
<span class="c1"># Note, in this example zero is a fixed point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Set knobs</span>

<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Find fixed point</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric closed orbit</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>

<span class="c1"># Print series representation</span>

<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">pfp</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(0, 0, 0, 0, 0): [0. 0. 0. 0.]
(0, 0, 0, 0, 1): [1.81613351 0.         0.         0.        ]
(0, 0, 0, 0, 2): [0.56855511 0.         0.         0.        ]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check convergence</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pfp</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">+</span> <span class="mf">1.0E-3</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pfp</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">+</span> <span class="mf">1.0E-3</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">pfp</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">+</span> <span class="mf">1.0E-3</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">+</span> <span class="mf">1.0E-3</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">chop</span><span class="p">([</span><span class="n">out</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
tensor([1.81613351e-03, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00], dtype=torch.float64)
tensor([1.81670206e-03, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00], dtype=torch.float64)

tensor([  1.81670185e-03,   1.13882757e-19, -5.50391130e-235,   0.00000000e+00], dtype=torch.float64)

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate closed orbit</span>

<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">jet</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jet</span><span class="p">)</span>

<span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
    <span class="n">jet</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">mapping</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jet</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check periodicity</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="n">jet</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot 1st order dispersion</span>

<span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.50</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">,</span> <span class="mf">4.95</span><span class="p">,</span> <span class="mf">5.05</span><span class="p">,</span> <span class="mf">5.50</span><span class="p">,</span> <span class="mf">6.00</span><span class="p">,</span> <span class="mf">6.50</span><span class="p">,</span> <span class="mf">6.95</span><span class="p">,</span> <span class="mf">7.05</span><span class="p">,</span> <span class="mf">7.50</span><span class="p">,</span> <span class="mf">10.50</span><span class="p">,</span> <span class="mf">10.95</span><span class="p">,</span> <span class="mf">11.05</span><span class="p">,</span> <span class="mf">11.50</span><span class="p">,</span> <span class="mf">12.00</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">jet</span><span class="p">)[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">jet</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_117_0.png" src="../_images/examples_ndtorch_117_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot 2nd order dispersion</span>

<span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.50</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">,</span> <span class="mf">4.95</span><span class="p">,</span> <span class="mf">5.05</span><span class="p">,</span> <span class="mf">5.50</span><span class="p">,</span> <span class="mf">6.00</span><span class="p">,</span> <span class="mf">6.50</span><span class="p">,</span> <span class="mf">6.95</span><span class="p">,</span> <span class="mf">7.05</span><span class="p">,</span> <span class="mf">7.50</span><span class="p">,</span> <span class="mf">10.50</span><span class="p">,</span> <span class="mf">10.95</span><span class="p">,</span> <span class="mf">11.05</span><span class="p">,</span> <span class="mf">11.50</span><span class="p">,</span> <span class="mf">12.00</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">jet</span><span class="p">)[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">jet</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_118_0.png" src="../_images/examples_ndtorch_118_0.png" />
</div>
</div>
</section>
<section id="Example-12:-Closed-orbit-(quadrupole-shift)">
<h1>Example-12: Closed orbit (quadrupole shift)<a class="headerlink" href="#Example-12:-Closed-orbit-(quadrupole-shift)" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">dxf</span><span class="p">,</span> <span class="n">dyf</span><span class="p">,</span> <span class="n">dxd</span><span class="p">,</span> <span class="n">dyd</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">dxf</span><span class="p">,</span> <span class="o">-</span><span class="n">dyf</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">+</span><span class="n">dxd</span><span class="p">,</span> <span class="o">+</span><span class="n">dyd</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">dxd</span><span class="p">,</span> <span class="o">-</span><span class="n">dyd</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">+</span><span class="n">dxf</span><span class="p">,</span> <span class="o">+</span><span class="n">dyf</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">transport</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">map_01_02</span>
<span class="p">]</span>

<span class="c1"># Define one-turn transport</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute fixed point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric fixed point</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">pfp</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[-4.621551e-01, 0.000000e+00, 1.165780e+00, 0.000000e+00],
          [0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00],
          [0.000000e+00, 3.344042e+00, 0.000000e+00, -4.891066e+00],
          [0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric fixed point</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[-4.621551e-01, 0.000000e+00, 1.165780e+00, 0.000000e+00],
          [0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00],
          [0.000000e+00, 3.344042e+00, 0.000000e+00, -4.891066e+00],
          [0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test single random shift</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="mf">1.0E-3</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0E-9</span><span class="p">)</span>
<span class="n">chop</span><span class="p">([</span><span class="n">fp</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([8.482363e-04, 8.125977e-21, 3.353913e-03, 6.171311e-20], dtype=torch.float64)
tensor([8.482363e-04, 0.000000e+00, 3.353913e-03, 0.000000e+00], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate center &amp; spread (tracking)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="mf">1.0E-3</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">8192</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">))(</span><span class="n">d</span><span class="p">)</span>
<span class="n">chop</span><span class="p">([</span><span class="n">fp</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([-9.932218e-06,  4.372133e-22, -1.483549e-06,  1.693071e-21], dtype=torch.float64)
tensor([1.253079e-03, 9.554150e-20, 5.881071e-03, 3.289974e-19], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate center &amp; spread (surrogate)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="mf">1.0E-3</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">8192</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">]))(</span><span class="n">d</span><span class="p">)</span>
<span class="n">chop</span><span class="p">([</span><span class="n">fp</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([ 3.969686e-06,  0.000000e+00, -2.718688e-05,  0.000000e+00], dtype=torch.float64)
tensor([1.240640e-03, 0.000000e+00, 5.905480e-03, 0.000000e+00], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate spread (error propagation)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">]),</span> <span class="n">d</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">((</span><span class="n">s</span> <span class="o">@</span> <span class="p">(</span><span class="mf">1.0E-3</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">@</span> <span class="n">s</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">diag</span><span class="p">()</span><span class="o">.</span><span class="n">sqrt</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.254045e-03, 0.000000e+00, 5.924960e-03, 0.000000e+00], dtype=torch.float64)
</pre></div></div>
</div>
</section>
<section id="Example-13:-Closed-orbit-(sextupole-shift)">
<h1>Example-13: Closed orbit (sextupole shift)<a class="headerlink" href="#Example-13:-Closed-orbit-(sextupole-shift)" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">dxsf1</span><span class="p">,</span> <span class="n">dysf1</span><span class="p">,</span> <span class="n">dxsd1</span><span class="p">,</span> <span class="n">dysd1</span><span class="p">,</span> <span class="n">dxsf2</span><span class="p">,</span> <span class="n">dysf2</span><span class="p">,</span> <span class="n">dxsd2</span><span class="p">,</span> <span class="n">dysd2</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">+</span><span class="n">dxsf1</span><span class="p">,</span> <span class="o">+</span><span class="n">dysf1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">dxsf1</span><span class="p">,</span> <span class="o">-</span><span class="n">dysf1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">+</span><span class="n">dxsd1</span><span class="p">,</span> <span class="o">+</span><span class="n">dysd1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">dxsd1</span><span class="p">,</span> <span class="o">-</span><span class="n">dysd1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">+</span><span class="n">dxsd2</span><span class="p">,</span> <span class="o">+</span><span class="n">dysd2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">dxsd2</span><span class="p">,</span> <span class="o">-</span><span class="n">dysd2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">+</span><span class="n">dxsf2</span><span class="p">,</span> <span class="o">+</span><span class="n">dysf2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">dxsf2</span><span class="p">,</span> <span class="o">-</span><span class="n">dysf2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">transport</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">map_01_02</span>
<span class="p">]</span>

<span class="c1"># Define one-turn transport</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute fixed point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute &amp; check parametric fixed point</span>
<span class="c1"># Note, there is no first order contribution from sextupole shifts</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test for a random shift</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="mf">1.0E-3</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0E-9</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([ 2.446138e-07, -1.144473e-08, -8.221335e-07,  6.156318e-09], dtype=torch.float64)
tensor([ 2.442916e-07, -1.142839e-08, -8.240374e-07,  6.170032e-09], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate center &amp; spread (tracking)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="mf">1.0E-3</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">8192</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">))(</span><span class="n">d</span><span class="p">)</span>
<span class="n">chop</span><span class="p">([</span><span class="n">fp</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([-1.018030e-09, -2.975896e-10, -1.314171e-08, -2.126598e-11], dtype=torch.float64)
tensor([6.895581e-07, 3.187716e-08, 1.813973e-06, 2.939394e-08], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate center &amp; spread (surrogate)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="mf">1.0E-3</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">8192</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">]))(</span><span class="n">d</span><span class="p">)</span>
<span class="n">chop</span><span class="p">([</span><span class="n">fp</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([-4.887936e-09, -1.410492e-10, -3.069499e-09, -4.740614e-10], dtype=torch.float64)
tensor([6.769223e-07, 3.104300e-08, 1.819394e-06, 2.833964e-08], dtype=torch.float64)
</pre></div></div>
</div>
</section>
<section id="Example-14:-Closed-orbit-(responce-matrix-&amp;-correction)">
<h1>Example-14: Closed orbit (responce matrix &amp; correction)<a class="headerlink" href="#Example-14:-Closed-orbit-(responce-matrix-&-correction)" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this example orbit responce matrix is computed</span>
<span class="c1"># Quadrupole shifts are introduced and responce matrix is used to correct the orbit at observation locations</span>

<span class="c1"># Correctors are at sextupole centers</span>
<span class="c1"># Observation points are at bend centers</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">cxsf1</span><span class="p">,</span> <span class="n">cxsd1</span><span class="p">,</span> <span class="n">cxsf2</span><span class="p">,</span> <span class="n">cxsd2</span><span class="p">,</span> <span class="n">cysf1</span><span class="p">,</span> <span class="n">cysd1</span><span class="p">,</span> <span class="n">cysf2</span><span class="p">,</span> <span class="n">cysd2</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">dxf</span><span class="p">,</span> <span class="n">dyf</span><span class="p">,</span> <span class="n">dxd</span><span class="p">,</span> <span class="n">dyd</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">dxf</span><span class="p">,</span> <span class="o">-</span><span class="n">dyf</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cxsf1</span><span class="p">,</span> <span class="n">cysf1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">map_02_03</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">cxsf1</span><span class="p">,</span> <span class="n">cxsd1</span><span class="p">,</span> <span class="n">cxsf2</span><span class="p">,</span> <span class="n">cxsd2</span><span class="p">,</span> <span class="n">cysf1</span><span class="p">,</span> <span class="n">cysd1</span><span class="p">,</span> <span class="n">cysf2</span><span class="p">,</span> <span class="n">cysd2</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">dxf</span><span class="p">,</span> <span class="n">dyf</span><span class="p">,</span> <span class="n">dxd</span><span class="p">,</span> <span class="n">dyd</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cxsd1</span><span class="p">,</span> <span class="n">cysd1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">+</span><span class="n">dxd</span><span class="p">,</span> <span class="o">+</span><span class="n">dyd</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">dxd</span><span class="p">,</span> <span class="o">-</span><span class="n">dyd</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cxsd2</span><span class="p">,</span> <span class="n">cysd2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">map_03_04</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">cxsf1</span><span class="p">,</span> <span class="n">cxsd1</span><span class="p">,</span> <span class="n">cxsf2</span><span class="p">,</span> <span class="n">cxsd2</span><span class="p">,</span> <span class="n">cysf1</span><span class="p">,</span> <span class="n">cysd1</span><span class="p">,</span> <span class="n">cysf2</span><span class="p">,</span> <span class="n">cysd2</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">dxf</span><span class="p">,</span> <span class="n">dyf</span><span class="p">,</span> <span class="n">dxd</span><span class="p">,</span> <span class="n">dyd</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cxsf2</span><span class="p">,</span> <span class="n">cysf2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">+</span><span class="n">dxf</span><span class="p">,</span> <span class="o">+</span><span class="n">dyf</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">transport</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">map_01_02</span><span class="p">,</span>
    <span class="n">map_02_03</span><span class="p">,</span>
    <span class="n">map_03_04</span>
<span class="p">]</span>

<span class="c1"># Define one-turn transport</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute fixed point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric fixed point</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">pfp</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[7.583253e+00, 5.939607e+00, 7.583253e+00, 5.939607e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00],
          [-4.334732e-01, -9.086786e-02, 4.334732e-01, 9.086786e-02, 0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00],
          [0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, 1.349234e+01, 2.165892e+01, 1.349234e+01, 2.165892e+01],
          [0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, -4.019148e-01, -7.725758e-02, 4.019148e-01, 7.725758e-02]],
         dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric fixed point</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[7.583253e+00, 5.939607e+00, 7.583253e+00, 5.939607e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00],
          [-4.334732e-01, -9.086786e-02, 4.334732e-01, 9.086786e-02, 0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00],
          [0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, 1.349234e+01, 2.165892e+01, 1.349234e+01, 2.165892e+01],
          [0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, -4.019148e-01, -7.725758e-02, 4.019148e-01, 7.725758e-02]],
         dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Orbit derivatives at observation locations</span>

<span class="n">bag</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">map_01_02</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">bag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">map_02_03</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">bag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute responce matrix</span>

<span class="k">def</span> <span class="nf">orbit</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">pfp</span><span class="p">):</span>
    <span class="n">qx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">])</span>

<span class="n">pfp1</span><span class="p">,</span> <span class="n">pfp2</span> <span class="o">=</span> <span class="n">bag</span>

<span class="n">rx1</span><span class="p">,</span> <span class="n">ry1</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">pfp1</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">rx2</span><span class="p">,</span> <span class="n">ry2</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">pfp2</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">rm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rx1</span><span class="p">,</span> <span class="n">rx2</span><span class="p">,</span> <span class="n">ry1</span><span class="p">,</span> <span class="n">ry2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[6.221115e+00, 4.042085e+00, 6.753998e+00, 4.569069e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00],
        [6.753998e+00, 4.569069e+00, 6.221115e+00, 4.042085e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00],
        [0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, 1.808222e+01, 2.754871e+01, 1.855563e+01, 2.802741e+01],
        [0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, 1.855563e+01, 2.802741e+01, 1.808222e+01, 2.754871e+01]],
       dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate perturbed orbit</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">qx1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">qy1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="n">qx2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">qy2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">map_02_03</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

<span class="n">o</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx1</span><span class="p">,</span> <span class="n">qx2</span><span class="p">,</span> <span class="n">qy1</span><span class="p">,</span> <span class="n">qy2</span><span class="p">])</span>
<span class="n">chop</span><span class="p">([</span><span class="n">o</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([-2.161122e-03, -2.161122e-03, -3.001730e-03, -3.001730e-03], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correct orbit</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">rm</span><span class="p">)</span> <span class="o">@</span> <span class="n">o</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">qx1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">qy1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="n">qx2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">qy2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">map_02_03</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

<span class="n">o</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx1</span><span class="p">,</span> <span class="n">qx2</span><span class="p">,</span> <span class="n">qy1</span><span class="p">,</span> <span class="n">qy2</span><span class="p">])</span>
<span class="n">chop</span><span class="p">([</span><span class="n">o</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([-1.070014e-18,  3.763685e-18, -1.733072e-17, -1.661201e-17], dtype=torch.float64)
</pre></div></div>
</div>
</section>
<section id="Example-15:-Tune-(chromaticity)">
<h1>Example-15: Tune (chromaticity)<a class="headerlink" href="#Example-15:-Tune-(chromaticity)" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">ksf</span><span class="p">,</span> <span class="n">ksd</span><span class="p">,</span> <span class="n">ksb</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ksf</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">ksb</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ksd</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ksd</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">ksb</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ksf</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">transport</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">map_01_02</span>
<span class="p">]</span>

<span class="c1"># Define one-turn transport</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute fixed point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric fixed point</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">pfp</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[[tensor([0., 0., 0., 0.], dtype=torch.float64),
   tensor([[0., 0., 0.],
           [0., 0., 0.],
           [0., 0., 0.],
           [0., 0., 0.]], dtype=torch.float64)],
  [tensor([[1.816134e+00],
           [0.000000e+00],
           [0.000000e+00],
           [0.000000e+00]], dtype=torch.float64),
   tensor([[[0.],
            [0.],
            [0.]],

           [[0.],
            [0.],
            [0.]],

           [[0.],
            [0.],
            [0.]],

           [[0.],
            [0.],
            [0.]]], dtype=torch.float64)]]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric fixed point</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[[tensor([0., 0., 0., 0.], dtype=torch.float64),
   tensor([[0., 0., 0.],
           [0., 0., 0.],
           [0., 0., 0.],
           [0., 0., 0.]], dtype=torch.float64)],
  [tensor([[1.816134e+00],
           [0.000000e+00],
           [0.000000e+00],
           [0.000000e+00]], dtype=torch.float64),
   tensor([[[0.],
            [0.],
            [0.]],

           [[0.],
            [0.],
            [0.]],

           [[0.],
            [0.],
            [0.]],

           [[0.],
            [0.],
            [0.]]], dtype=torch.float64)]]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric identity (surrogate model for linear dynamics)</span>

<span class="n">jet</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">jet</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute tune</span>

<span class="k">def</span> <span class="nf">tune</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">fp</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tune</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.527795e-01, 1.199104e-01], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric tune</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">tune</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([2.527795e-01, 1.199104e-01], dtype=torch.float64), tensor([[0., 0., 0.],
        [0., 0., 0.]], dtype=torch.float64)], [tensor([[-2.343079e-01],
        [-2.416176e-01]], dtype=torch.float64), tensor([[[3.618782e-01],
         [8.705079e-02],
         [5.873074e+00]],

        [[-2.986097e-01],
         [-4.727344e-01],
         [-1.106560e+01]]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check convergence</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span> <span class="o">+</span> <span class="mf">1.0E-3</span><span class="p">,</span> <span class="n">k</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tune</span><span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="mf">1.0E-3</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.527795e-01, 1.199104e-01], dtype=torch.float64)
tensor([2.525452e-01, 1.196688e-01], dtype=torch.float64)

tensor([2.525452e-01, 1.196687e-01], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check convergence</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span> <span class="o">+</span> <span class="mf">1.0E-3</span><span class="p">,</span> <span class="n">k</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span> <span class="o">+</span> <span class="mf">1.0E-3</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mf">1.0E-2</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tune</span><span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="mf">1.0E-3</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mf">1.0E-2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.527795e-01, 1.199104e-01], dtype=torch.float64)
tensor([2.525452e-01, 1.196688e-01], dtype=torch.float64)
tensor([2.526084e-01, 1.195504e-01], dtype=torch.float64)

tensor([2.526084e-01, 1.195502e-01], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Series representation</span>

<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">clean</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">t</span><span class="p">))</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(0, 0, 0, 0): tensor([2.527795e-01, 1.199104e-01], dtype=torch.float64)
(1, 0, 0, 0): tensor([-2.343079e-01, -2.416176e-01], dtype=torch.float64)
(1, 1, 0, 0): tensor([3.618782e-01, -2.986097e-01], dtype=torch.float64)
(1, 0, 1, 0): tensor([8.705079e-02, -4.727344e-01], dtype=torch.float64)
(1, 0, 0, 1): tensor([5.873074e+00, -1.106560e+01], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set chromaticity to zero</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">w</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="o">-</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span> <span class="o">@</span> <span class="n">b</span><span class="p">)]),</span> <span class="n">w</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([-2.343079e-01, -2.416176e-01], dtype=torch.float64)
tensor([-2.914335e-15,  1.165734e-15], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set chromaticity to one</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">w</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="o">-</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span> <span class="o">@</span> <span class="n">b</span><span class="p">)]),</span> <span class="n">w</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([-2.343079e-01, -2.416176e-01], dtype=torch.float64)
tensor([1.000000e+00, 1.000000e+00], dtype=torch.float64)
</pre></div></div>
</div>
</section>
<section id="Example-16:-Tune-(responce-matrix-&amp;-correction)">
<h1>Example-16: Tune (responce matrix &amp; correction)<a class="headerlink" href="#Example-16:-Tune-(responce-matrix-&-correction)" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">kqf</span><span class="p">,</span> <span class="n">kqd</span><span class="p">,</span> <span class="n">kqb</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span> <span class="o">+</span> <span class="n">kqf</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">kqb</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span> <span class="o">+</span> <span class="n">kqd</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span> <span class="o">+</span> <span class="n">kqd</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">kqb</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span> <span class="o">+</span> <span class="n">kqf</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">transport</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">map_01_02</span>
<span class="p">]</span>

<span class="c1"># Define one-turn transport</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute fixed point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric fixed point</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">pfp</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric fixed point</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric identity (surrogate model for linear dynamics)</span>

<span class="n">jet</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">jet</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute tune</span>

<span class="k">def</span> <span class="nf">tune</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">fp</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tune</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.527795e-01, 1.199104e-01], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric tune</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">tune</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check convergence</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">5.0E-3</span><span class="p">,</span> <span class="mf">5.0E-3</span><span class="p">,</span> <span class="mf">1.0E-3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)]))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tune</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">5.0E-3</span><span class="p">,</span> <span class="mf">5.0E-3</span><span class="p">,</span> <span class="mf">1.0E-3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.527795e-01, 1.199104e-01], dtype=torch.float64)
tensor([2.646746e-01, 9.564416e-02], dtype=torch.float64)

tensor([2.646564e-01, 9.339156e-02], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Responce matrix</span>

<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[1.217003e+00, 3.230152e-01, 4.195000e+00],
        [-7.757018e-01, -2.437956e+00, -8.197983e+00]], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correct tunes (increase horizontal by 0.01)</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tune</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tune</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">@</span> <span class="n">b</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.527795e-01, 1.199104e-01], dtype=torch.float64)
tensor([2.627666e-01, 1.199040e-01], dtype=torch.float64)

</pre></div></div>
</div>
</section>
<section id="Example-17:-Tune-(spread)">
<h1>Example-17: Tune (spread)<a class="headerlink" href="#Example-17:-Tune-(spread)" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">kqf</span><span class="p">,</span> <span class="n">kqd</span><span class="p">,</span> <span class="n">kqb</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span> <span class="o">+</span> <span class="n">kqf</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">kqb</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span> <span class="o">+</span> <span class="n">kqd</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span> <span class="o">+</span> <span class="n">kqd</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">kqb</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span> <span class="o">+</span> <span class="n">kqf</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">transport</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">map_01_02</span>
<span class="p">]</span>

<span class="c1"># Define one-turn transport</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute fixed point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric fixed point</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">pfp</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.]], dtype=torch.float64),
  tensor([[[0., 0., 0.],
           [0., 0., 0.],
           [0., 0., 0.]],

          [[0., 0., 0.],
           [0., 0., 0.],
           [0., 0., 0.]],

          [[0., 0., 0.],
           [0., 0., 0.],
           [0., 0., 0.]],

          [[0., 0., 0.],
           [0., 0., 0.],
           [0., 0., 0.]]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric fixed point</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.]], dtype=torch.float64),
  tensor([[[0., 0., 0.],
           [0., 0., 0.],
           [0., 0., 0.]],

          [[0., 0., 0.],
           [0., 0., 0.],
           [0., 0., 0.]],

          [[0., 0., 0.],
           [0., 0., 0.],
           [0., 0., 0.]],

          [[0., 0., 0.],
           [0., 0., 0.],
           [0., 0., 0.]]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric identity (surrogate model for linear dynamics)</span>

<span class="n">jet</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">jet</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute tune</span>

<span class="k">def</span> <span class="nf">tune</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">fp</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tune</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.527795e-01, 1.199104e-01], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute tune spread (direct)</span>

<span class="n">sf</span> <span class="o">=</span> <span class="mf">1.0E-3</span>
<span class="n">sd</span> <span class="o">=</span> <span class="mf">1.0E-3</span>
<span class="n">sb</span> <span class="o">=</span> <span class="mf">1.0E-4</span>

<span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="n">err</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">sf</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">sb</span><span class="p">])</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">wrapper</span><span class="p">)(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.527650e-01, 1.198656e-01], dtype=torch.float64)
tensor([1.958515e-03, 4.040516e-03], dtype=torch.float64)

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric tune</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">tune</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute tune spread (surrogate)</span>

<span class="n">sf</span> <span class="o">=</span> <span class="mf">1.0E-3</span>
<span class="n">sd</span> <span class="o">=</span> <span class="mf">1.0E-3</span>
<span class="n">sb</span> <span class="o">=</span> <span class="mf">1.0E-4</span>

<span class="n">err</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">sf</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">sb</span><span class="p">])</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">]))(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.528075e-01, 1.198527e-01], dtype=torch.float64)
tensor([1.973939e-03, 4.063140e-03], dtype=torch.float64)

</pre></div></div>
</div>
</section>
<section id="Example-18:-Parametric-twiss">
<h1>Example-18: Parametric twiss<a class="headerlink" href="#Example-18:-Parametric-twiss" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>
<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">propagate</span> <span class="k">as</span> <span class="n">propagate_twiss</span>
<span class="kn">from</span> <span class="nn">twiss.convert</span> <span class="kn">import</span> <span class="n">wolski_to_cs</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">kqf</span><span class="p">,</span> <span class="n">kqd</span><span class="p">,</span> <span class="n">kqb</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span> <span class="o">+</span> <span class="n">kqf</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">kqb</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">map_02_03</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">kqf</span><span class="p">,</span> <span class="n">kqd</span><span class="p">,</span> <span class="n">kqb</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">kqb</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span> <span class="o">+</span> <span class="n">kqd</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span> <span class="o">+</span> <span class="n">kqd</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">kqb</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">map_03_04</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">kqf</span><span class="p">,</span> <span class="n">kqd</span><span class="p">,</span> <span class="n">kqb</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">kqb</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span> <span class="o">+</span> <span class="n">kqf</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">transport</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">map_01_02</span><span class="p">,</span>
    <span class="n">map_02_03</span><span class="p">,</span>
    <span class="n">map_03_04</span>
<span class="p">]</span>

<span class="c1"># Define one-turn transport</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute fixed point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric fixed point</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">pfp</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric fixed point</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric identity (surrogate model for linear dynamics)</span>

<span class="n">jet</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">jet</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute twiss</span>

<span class="c1"># Note, exact or jet one-turn transport can be used</span>
<span class="c1"># Other maps can be replaced with jets too</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="p">):</span>

    <span class="n">bxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bys</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">wolski_to_cs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">propagate_twiss</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">wolski_to_cs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">bxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bx</span><span class="p">)</span>
        <span class="n">bys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">by</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">bxs</span><span class="p">,</span> <span class="o">*</span><span class="n">bys</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.528e-01, 1.199e-01, 8.703e+00, 8.703e+00, 1.553e+01, 1.678e+01, 1.678e+01, 9.586e+00], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric derivative using exact map (tune &amp; beta)</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)),</span> <span class="n">k</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[tensor([2.528e-01, 1.199e-01, 8.703e+00, 8.703e+00, 1.553e+01, 1.678e+01, 1.678e+01, 9.586e+00], dtype=torch.float64), tensor([[ 1.217e+00,  3.230e-01,  4.195e+00],
        [-7.757e-01, -2.438e+00, -8.198e+00],
        [-3.111e+01, -1.531e+01, -1.101e+02],
        [-3.111e+01, -1.531e+01, -1.101e+02],
        [-1.749e+00, -3.120e+01, -1.799e+02],
        [ 1.153e+02,  3.308e+02,  1.106e+03],
        [ 1.153e+02,  3.308e+02,  1.106e+03],
        [ 5.215e+01,  2.146e+02,  6.957e+02]], dtype=torch.float64)]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric derivative using jet map (tune &amp; beta)</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">])),</span> <span class="n">k</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[tensor([2.528e-01, 1.199e-01, 8.703e+00, 8.703e+00, 1.553e+01, 1.678e+01, 1.678e+01, 9.586e+00], dtype=torch.float64), tensor([[ 1.217e+00,  3.230e-01,  4.195e+00],
        [-7.757e-01, -2.438e+00, -8.198e+00],
        [-3.111e+01, -1.531e+01, -1.101e+02],
        [-3.111e+01, -1.531e+01, -1.101e+02],
        [-1.749e+00, -3.120e+01, -1.799e+02],
        [ 1.153e+02,  3.308e+02,  1.106e+03],
        [ 1.153e+02,  3.308e+02,  1.106e+03],
        [ 5.215e+01,  2.146e+02,  6.957e+02]], dtype=torch.float64)]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check covergence</span>

<span class="n">dk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0E-3</span><span class="p">,</span> <span class="mf">1.0E-3</span><span class="p">,</span> <span class="mf">1.0E-4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]))</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="n">dk</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]))</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">dk</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">dk</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.253 0.120 8.703 8.703 15.532 16.780 16.780 9.586
0.255 0.116 8.645 8.645 15.481 17.337 17.337 9.922
0.255 0.116 8.646 8.646 15.482 17.366 17.366 9.940
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Responce matrix</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">])),</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[ 1.217e+00,  3.230e-01,  4.195e+00],
        [-7.757e-01, -2.438e+00, -8.198e+00],
        [-3.111e+01, -1.531e+01, -1.101e+02],
        [-3.111e+01, -1.531e+01, -1.101e+02],
        [-1.749e+00, -3.120e+01, -1.799e+02],
        [ 1.153e+02,  3.308e+02,  1.106e+03],
        [ 1.153e+02,  3.308e+02,  1.106e+03],
        [ 5.215e+01,  2.146e+02,  6.957e+02]], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correction</span>

<span class="c1"># The target values (tunes and beta functions) are associated with model response matrix</span>
<span class="c1"># Given measured values, the goal is to alter knobs to get target values</span>

<span class="c1"># Set target values</span>

<span class="n">vf</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>

<span class="c1"># Set initial solution</span>

<span class="n">sol</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dk</span><span class="p">)</span>

<span class="c1"># Iterate</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>

    <span class="c1"># Compute current values and set difference</span>

    <span class="n">vi</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">dk</span> <span class="o">+</span> <span class="n">sol</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">dk</span> <span class="o">+</span> <span class="n">sol</span><span class="p">]))</span>

    <span class="c1"># Set difference</span>

    <span class="n">dv</span> <span class="o">=</span> <span class="n">vf</span> <span class="o">-</span> <span class="n">vi</span>

    <span class="c1"># Update solution</span>

    <span class="n">sol</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">@</span> <span class="n">dv</span>

    <span class="c1"># Verbose</span>

    <span class="nb">print</span><span class="p">(</span><span class="o">-</span><span class="n">dk</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">norm</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># Continue</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor([-1.064e-03, -1.258e-03, -4.094e-05], dtype=torch.float64)
tensor(9.036e-01, dtype=torch.float64)

tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor([-1.000e-03, -1.000e-03, -9.990e-05], dtype=torch.float64)
tensor(4.251e-02, dtype=torch.float64)

tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor(8.589e-05, dtype=torch.float64)

tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor(3.559e-10, dtype=torch.float64)

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note, similar to tune spread example, it is possible to compute twiss spread</span>
<span class="c1"># First order computation can be performed using error propagation</span>
<span class="c1"># Or higher order jets can be sampled</span>
</pre></div>
</div>
</div>
</section>
<section id="Example-19:-Parametric-phase-advance">
<h1>Example-19: Parametric phase advance<a class="headerlink" href="#Example-19:-Parametric-phase-advance" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>
<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">propagate</span> <span class="k">as</span> <span class="n">propagate_twiss</span>
<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">advance</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">kqf</span><span class="p">,</span> <span class="n">kqd</span><span class="p">,</span> <span class="n">kqb</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span> <span class="o">+</span> <span class="n">kqf</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">kqb</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">map_02_03</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">kqf</span><span class="p">,</span> <span class="n">kqd</span><span class="p">,</span> <span class="n">kqb</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">kqb</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span> <span class="o">+</span> <span class="n">kqd</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span> <span class="o">+</span> <span class="n">kqd</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">kqb</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">map_03_04</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">kqf</span><span class="p">,</span> <span class="n">kqd</span><span class="p">,</span> <span class="n">kqb</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">kqb</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span> <span class="o">+</span> <span class="n">kqf</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">transport</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">map_01_02</span><span class="p">,</span>
    <span class="n">map_02_03</span><span class="p">,</span>
    <span class="n">map_03_04</span>
<span class="p">]</span>

<span class="c1"># Define one-turn transport</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute fixed point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric fixed point</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">pfp</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric fixed point</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.],
          [0., 0., 0.]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate parametric identity (surrogate model for linear dynamics)</span>

<span class="n">jet</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">jet</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute phase advance</span>

<span class="c1"># Note, exact or jet one-turn transport can be used</span>
<span class="c1"># Other maps can be replaced with jets too</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="p">):</span>

    <span class="n">mus</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">advance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">mus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

    <span class="n">mus</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mus</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">mus</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.528e-01, 1.199e-01, 2.521e-01, 1.084e+00, 2.521e-01, 2.468e-01, 2.599e-01, 2.468e-01], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric derivative using exact map (tune &amp; advance)</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)),</span> <span class="n">k</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[tensor([2.528e-01, 1.199e-01, 2.521e-01, 1.084e+00, 2.521e-01, 2.468e-01, 2.599e-01, 2.468e-01], dtype=torch.float64), tensor([[1.217e+00, 3.230e-01, 4.195e+00],
        [-7.757e-01, -2.438e+00, -8.198e+00],
        [4.458e-01, 4.852e-01, 2.926e+00],
        [6.755e+00, 1.059e+00, 2.051e+01],
        [4.458e-01, 4.852e-01, 2.926e+00],
        [-1.523e+00, -5.303e+00, -1.726e+01],
        [-1.827e+00, -4.712e+00, -1.699e+01],
        [-1.523e+00, -5.303e+00, -1.726e+01]], dtype=torch.float64)]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric derivative using jet map (tune &amp; advance)</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">])),</span> <span class="n">k</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[tensor([2.528e-01, 1.199e-01, 2.521e-01, 1.084e+00, 2.521e-01, 2.468e-01, 2.599e-01, 2.468e-01], dtype=torch.float64), tensor([[1.217e+00, 3.230e-01, 4.195e+00],
        [-7.757e-01, -2.438e+00, -8.198e+00],
        [4.458e-01, 4.852e-01, 2.926e+00],
        [6.755e+00, 1.059e+00, 2.051e+01],
        [4.458e-01, 4.852e-01, 2.926e+00],
        [-1.523e+00, -5.303e+00, -1.726e+01],
        [-1.827e+00, -4.712e+00, -1.699e+01],
        [-1.523e+00, -5.303e+00, -1.726e+01]], dtype=torch.float64)]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check covergence</span>

<span class="n">dk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0E-3</span><span class="p">,</span> <span class="mf">1.0E-3</span><span class="p">,</span> <span class="mf">1.0E-4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]))</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="n">dk</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]))</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">dk</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">dk</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.253 0.120 0.252 1.084 0.252 0.247 0.260 0.247
0.255 0.116 0.253 1.094 0.253 0.238 0.252 0.238
0.255 0.116 0.253 1.094 0.253 0.238 0.251 0.238
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Responce matrix</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">])),</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[1.217e+00, 3.230e-01, 4.195e+00],
        [-7.757e-01, -2.438e+00, -8.198e+00],
        [4.458e-01, 4.852e-01, 2.926e+00],
        [6.755e+00, 1.059e+00, 2.051e+01],
        [4.458e-01, 4.852e-01, 2.926e+00],
        [-1.523e+00, -5.303e+00, -1.726e+01],
        [-1.827e+00, -4.712e+00, -1.699e+01],
        [-1.523e+00, -5.303e+00, -1.726e+01]], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correction</span>

<span class="c1"># The target values (tunes and advance functions) are associated with model response matrix</span>
<span class="c1"># Given measured values, the goal is to alter knobs to get target values</span>

<span class="c1"># Set target values</span>

<span class="n">vf</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>

<span class="c1"># Set initial solution</span>

<span class="n">sol</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dk</span><span class="p">)</span>

<span class="c1"># Iterate</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>

    <span class="c1"># Compute current values and set difference</span>

    <span class="n">vi</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">dk</span> <span class="o">+</span> <span class="n">sol</span><span class="p">,</span> <span class="n">fodo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">dk</span> <span class="o">+</span> <span class="n">sol</span><span class="p">]))</span>

    <span class="c1"># Set difference</span>

    <span class="n">dv</span> <span class="o">=</span> <span class="n">vf</span> <span class="o">-</span> <span class="n">vi</span>

    <span class="c1"># Update solution</span>

    <span class="n">sol</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">@</span> <span class="n">dv</span>

    <span class="c1"># Verbose</span>

    <span class="nb">print</span><span class="p">(</span><span class="o">-</span><span class="n">dk</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">norm</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># Continue</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor([-1.043e-03, -1.068e-03, -8.224e-05], dtype=torch.float64)
tensor(1.846e-02, dtype=torch.float64)

tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor(2.001e-04, dtype=torch.float64)

tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor(2.786e-08, dtype=torch.float64)

tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor([-1.000e-03, -1.000e-03, -1.000e-04], dtype=torch.float64)
tensor(2.344e-15, dtype=torch.float64)

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note, similar to tune spread example, it is possible to compute advance spread</span>
<span class="c1"># First order computation can be performed using error propagation</span>
<span class="c1"># Or higher order jets can be sampled</span>
</pre></div>
</div>
</div>
</section>
<section id="Example-20:-Poisson-bracket">
<h1>Example-20: Poisson bracket<a class="headerlink" href="#Example-20:-Poisson-bracket" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.bracket</span> <span class="kn">import</span> <span class="n">bracket</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Poisson bracket between observable/mapping or mapping/observable or mapping/mapping</span>

<span class="c1"># [f, g]                   -&gt; [f, g]</span>
<span class="c1"># [[f1, f2], g]            -&gt; [[f1, g], [f2, g]]</span>
<span class="c1"># [f, [g1, g2]]            -&gt; [[f, g1], [f, g2]]</span>
<span class="c1"># [[f1, f2], [g1, g2]]     -&gt; [[f1, g1], [f2, g2]]</span>


<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span> <span class="k">return</span> <span class="n">q</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span> <span class="k">return</span> <span class="n">p</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bracket</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)(</span><span class="n">x</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span> <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span> <span class="k">return</span> <span class="n">p</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bracket</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)(</span><span class="n">x</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span> <span class="k">return</span> <span class="n">q</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span> <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bracket</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)(</span><span class="n">x</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span> <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span> <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bracket</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor(1.000e+00, dtype=torch.float64)
tensor([1.000e+00, 0.000e+00], dtype=torch.float64)
tensor([0.000e+00, 1.000e+00], dtype=torch.float64)
tensor([0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Returns a function that can be differentiated</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span> <span class="k">return</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span> <span class="k">return</span> <span class="n">p</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bracket</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.000e+00, 0.000e+00], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Accepts Table input</span>
<span class="c1"># Note, evaluation is at deviation point</span>

<span class="n">tf</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">identity</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="p">[],</span> <span class="n">f</span><span class="p">)</span>
<span class="n">tg</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">identity</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="p">[],</span> <span class="n">g</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bracket</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="n">tg</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.000e+00, 0.000e+00], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Accepts Series input</span>
<span class="c1"># Note, evaluation is at deviation point</span>

<span class="n">sf</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">identity</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">flag</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="p">[],</span> <span class="n">f</span><span class="p">)</span>
<span class="n">sg</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">identity</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">flag</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="p">[],</span> <span class="n">g</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bracket</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="n">tg</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.000e+00, 0.000e+00], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate identity</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">identity</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="p">[],</span> <span class="n">bracket</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[tensor(0., dtype=torch.float64), tensor([2.000e+00, 0.000e+00], dtype=torch.float64)]
</pre></div></div>
</div>
</section>
<section id="Example-21:-Taylor-integrator">
<h1>Example-21: Taylor integrator<a class="headerlink" href="#Example-21:-Taylor-integrator" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given an autonomous hamiltonian function H</span>
<span class="c1"># The exact solution is x(t) = exp([-t H]) x with Poisson bracket operator [f] g := [f, g]</span>
<span class="c1"># Truncated solution is x(t) = exp([-t H]) x = x + t [-H] x + 1/2! t**2 [-H]**2 x + ...</span>
<span class="c1"># Such series solution doesn&#39;t preserve symplectic structure in general</span>
<span class="c1"># Taylor integration is differentiable with respect to time step, initial value and parameters</span>

<span class="c1"># Note, generation or derivatives can be extremely slow</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.taylor</span> <span class="kn">import</span> <span class="n">taylor</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Integrate for a given time step and ititial condition</span>
<span class="c1"># Note, hamiltonian is not preserved for all cases, but the hamiltonian drift time scale is different</span>

<span class="c1"># Set nonlinear oscillator hamiltonian function</span>

<span class="k">def</span> <span class="nf">h</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>

<span class="c1"># Set time step</span>

<span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Set initial condition</span>

<span class="n">xi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Integrate and plot orbits for several values of truncation order</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">]):</span>
    <span class="n">orbit</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">taylor</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">orbit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">orbit</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">orbit</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">orbit</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_241_0.png" src="../_images/examples_ndtorch_241_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate derivative table representation at zero</span>
<span class="c1"># Note, here a smaller time step is used</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">taylor</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># Compute series representation</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">)</span>

<span class="c1"># Print series</span>

<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(0, 0): tensor([0., 0.])
(1, 0): tensor([9.987502e-01, -4.997917e-02])
(0, 1): tensor([4.997917e-02, 9.987502e-01])
(2, 0): tensor([-1.249219e-03, -4.993753e-02])
(1, 1): tensor([-4.164063e-05, -2.497397e-03])
(0, 2): tensor([-5.206163e-07, -4.164063e-05])
(3, 0): tensor([5.203993e-07, 4.161458e-05])
(2, 1): tensor([2.604167e-08, 2.601563e-06])
(1, 2): tensor([4.340278e-10, 5.208334e-08])
(0, 3): tensor([0.000000e+00, 4.340278e-10])
(4, 0): tensor([-2.170139e-10, -2.604167e-08])
(3, 1): tensor([ 0.000000e+00, -1.736111e-09])
(2, 2): tensor([0., 0.])
(1, 3): tensor([0., 0.])
(0, 4): tensor([0., 0.])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Integrate using derivative table and a batch of initials</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

<span class="n">orbits</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]))(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">orbits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">orbits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">orbits</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">orbit</span> <span class="ow">in</span> <span class="n">orbits</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">orbit</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_243_0.png" src="../_images/examples_ndtorch_243_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Derivatives with respect to time step and other parameters</span>

<span class="k">def</span> <span class="nf">h</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">kq</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ks</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>

<span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">xi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">kq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">ks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">xi</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">:</span> <span class="n">taylor</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">),</span> <span class="n">xi</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check table</span>

<span class="n">dxi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">ddt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">dkq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">dks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">taylor</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">ddt</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">xi</span> <span class="o">+</span> <span class="n">dxi</span><span class="p">,</span> <span class="n">kq</span> <span class="o">+</span> <span class="n">dkq</span><span class="p">,</span> <span class="n">ks</span> <span class="o">+</span> <span class="n">dks</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">dxi</span><span class="p">,</span> <span class="n">ddt</span><span class="p">,</span> <span class="n">dkq</span><span class="p">,</span> <span class="n">dks</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([4.999716e-01, -3.787356e-03])
tensor([4.999748e-01, -3.787395e-03])
</pre></div></div>
</div>
</section>
<section id="Example-22:-Yoshida-integrator">
<h1>Example-22: Yoshida integrator<a class="headerlink" href="#Example-22:-Yoshida-integrator" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given a time-reversible integration step of difference order 2n</span>
<span class="c1"># Yoshida coefficients can be used to construct integration step of difference order 2(n+1)</span>
<span class="c1"># s(2(n+1))(dt) = s(2n)(x1 dt) o s(2n)(x2 dt) o s(2n)(x1 dt)</span>

<span class="c1"># If a hamiltonian vector field can be splitted into several sovable parts</span>
<span class="c1"># Second order time-reversible symmetric integrator can be easily constructed</span>
<span class="c1"># s1(dt/2) o s2(dt/2) o ... o sn(dt/2) o sn(dt/2) o ... o s2(dt/2) o s1(dt/2)</span>
<span class="c1"># Yoshida procedure can be then applied repeatedly to obtain higher order integration steps</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.util</span> <span class="kn">import</span> <span class="n">first</span>
<span class="kn">from</span> <span class="nn">ndtorch.util</span> <span class="kn">import</span> <span class="n">nest</span>
<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.yoshida</span> <span class="kn">import</span> <span class="n">coefficients</span>
<span class="kn">from</span> <span class="nn">ndtorch.yoshida</span> <span class="kn">import</span> <span class="n">yoshida</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given integration step on Yoshida order n</span>
<span class="c1"># Yoshida coefficent for the next order can be computed</span>

<span class="c1"># Note, sum of coefficients is equal to one</span>

<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># 2 -&gt; 4</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># 4 -&gt; 6</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># 6 -&gt; 8</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="c1"># 8 -&gt; 10</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1.3512071919596578, -1.7024143839193153, 1.3512071919596578]
[1.1746717580893635, -1.349343516178727, 1.1746717580893635]
[1.1161829393253857, -1.2323658786507714, 1.1161829393253857]
[1.0870271062991708, -1.1740542125983413, 1.0870271062991708]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given integration step on Yoshida order n</span>
<span class="c1"># Yoshida coefficent for m order can be computed</span>

<span class="c1"># Note, sum of coefficients is equal to one</span>

<span class="nb">print</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coefficient</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">coefficient</span> <span class="ow">in</span> <span class="n">coefficients</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span> <span class="c1"># 2 -&gt; 4</span>
<span class="nb">print</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coefficient</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">coefficient</span> <span class="ow">in</span> <span class="n">coefficients</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span> <span class="c1"># 2 -&gt; 6</span>
<span class="nb">print</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coefficient</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">coefficient</span> <span class="ow">in</span> <span class="n">coefficients</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span> <span class="c1"># 4 -&gt; 6</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;1.351&#39;, &#39;-1.702&#39;, &#39;1.351&#39;]
[&#39;1.587&#39;, &#39;-2.000&#39;, &#39;1.587&#39;, &#39;-1.823&#39;, &#39;2.297&#39;, &#39;-1.823&#39;, &#39;1.587&#39;, &#39;-2.000&#39;, &#39;1.587&#39;]
[&#39;1.175&#39;, &#39;-1.349&#39;, &#39;1.175&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given a set of mappings and (start, final) Yoshida orders</span>
<span class="c1"># Corresponding Yoshida coefficients can be computed</span>
<span class="c1"># Note, mapping can be an integation step</span>

<span class="c1"># Mapping is a step (last argument should be False)</span>

<span class="n">ns</span><span class="p">,</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">([</span><span class="n">ns</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">]])</span> <span class="c1"># 2 -&gt; 4</span>
<span class="n">ns</span><span class="p">,</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">([</span><span class="n">ns</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">]])</span> <span class="c1"># 2 -&gt; 6</span>
<span class="n">ns</span><span class="p">,</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">([</span><span class="n">ns</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">]])</span> <span class="c1"># 4 -&gt; 6</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Two mappings (merge edge mappings)</span>
<span class="c1"># Note, number of mappings can be arbitrary</span>

<span class="n">ns</span><span class="p">,</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="p">;</span> <span class="nb">print</span><span class="p">([</span><span class="n">ns</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">]])</span> <span class="c1"># 2 -&gt; 2</span>
<span class="n">ns</span><span class="p">,</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="p">;</span> <span class="nb">print</span><span class="p">([</span><span class="n">ns</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">]])</span> <span class="c1"># 2 -&gt; 4</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[0, 0, 0], [&#39;1.351&#39;, &#39;-1.702&#39;, &#39;1.351&#39;]]
[[0, 0, 0, 0, 0, 0, 0, 0, 0], [&#39;1.587&#39;, &#39;-2.000&#39;, &#39;1.587&#39;, &#39;-1.823&#39;, &#39;2.297&#39;, &#39;-1.823&#39;, &#39;1.587&#39;, &#39;-2.000&#39;, &#39;1.587&#39;]]
[[0, 0, 0], [&#39;1.175&#39;, &#39;-1.349&#39;, &#39;1.175&#39;]]

[[0, 1, 0], [&#39;0.500&#39;, &#39;1.000&#39;, &#39;0.500&#39;]]
[[0, 1, 0, 1, 0, 1, 0], [&#39;0.676&#39;, &#39;1.351&#39;, &#39;-0.176&#39;, &#39;-1.702&#39;, &#39;-0.176&#39;, &#39;1.351&#39;, &#39;0.676&#39;]]

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Integrate rotation</span>

<span class="c1"># h = h1 + h2</span>
<span class="c1"># h1 = 1/2 q**2 -&gt; [q, p] -&gt; [q, p - t*q]</span>
<span class="c1"># h2 = 1/2 p**2 -&gt; [q, p] -&gt; [q + t*q, p]</span>

<span class="c1"># Set mappings</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">q</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">gn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>

<span class="c1"># Set time step</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="c1"># Set initial condition</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="c1"># Without merging</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])</span><span class="o">.</span><span class="n">table</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># With merging</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])</span><span class="o">.</span><span class="n">table</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.375000e-01, 4.062500e-02], dtype=torch.float64) 3
tensor([1.354787e-01, 3.997254e-02], dtype=torch.float64) 9
tensor([1.357446e-01, 3.982467e-02], dtype=torch.float64) 27
tensor([1.357004e-01, 3.981894e-02], dtype=torch.float64) 81
tensor([1.356984e-01, 3.981700e-02], dtype=torch.float64) 243
tensor([1.357016e-01, 3.981564e-02], dtype=torch.float64) 729
tensor([1.357009e-01, 3.981567e-02], dtype=torch.float64) 2187
tensor([1.357007e-01, 3.981572e-02], dtype=torch.float64) 6561
tensor([1.357009e-01, 3.981567e-02], dtype=torch.float64) 19683
tensor([1.357007e-01, 3.981573e-02], dtype=torch.float64) 59049

tensor([1.375000e-01, 4.062500e-02], dtype=torch.float64) 3
tensor([1.354787e-01, 3.997254e-02], dtype=torch.float64) 7
tensor([1.357446e-01, 3.982467e-02], dtype=torch.float64) 19
tensor([1.357004e-01, 3.981894e-02], dtype=torch.float64) 55
tensor([1.356984e-01, 3.981700e-02], dtype=torch.float64) 163
tensor([1.357016e-01, 3.981564e-02], dtype=torch.float64) 487
tensor([1.357009e-01, 3.981567e-02], dtype=torch.float64) 1459
tensor([1.357007e-01, 3.981572e-02], dtype=torch.float64) 4375
tensor([1.357009e-01, 3.981567e-02], dtype=torch.float64) 13123
tensor([1.357007e-01, 3.981573e-02], dtype=torch.float64) 39367

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Several steps</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="o">/</span><span class="n">count</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">nest</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">]))(</span><span class="n">x</span><span class="p">,</span>  <span class="n">t</span><span class="o">/</span><span class="n">count</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.357008e-01, 3.981570e-02], dtype=torch.float64)
tensor([1.357008e-01, 3.981570e-02], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Multistep</span>

<span class="c1"># h = h1 + h2</span>
<span class="c1"># h1 = 1/2 q**2 + 1/3 q**3 -&gt; [q, p] -&gt; [q, p - t*q - t*q**2]</span>
<span class="c1"># h2 = 1/2 p**2            -&gt; [q, p] -&gt; [q + t*q, p]</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">q</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">gn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># h = h1 + h2 + h3</span>
<span class="c1"># h1 = 1/2 q**2 -&gt; [q, p] -&gt; [q, p - t*q]</span>
<span class="c1"># h2 = 1/3 q**3 -&gt; [q, p] -&gt; [q, p - t*q**2]</span>
<span class="c1"># h3 = 1/2 p**2 -&gt; [q, p] -&gt; [q + t*q, p]</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">q</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">gn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">hn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">,</span> <span class="n">hn</span><span class="p">])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Note, the last mapping has the smallest number of evaluations</span>

<span class="n">sequence</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">,</span> <span class="n">hn</span><span class="p">])</span><span class="o">.</span><span class="n">table</span>

<span class="nb">print</span><span class="p">([</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sequence</span><span class="p">)))])</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.094304e-01, 8.841961e-02], dtype=torch.float64)

tensor([1.094304e-01, 8.841961e-02], dtype=torch.float64)

[4, 6, 3]

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Increase order</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">q</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">gn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">s2</span> <span class="o">=</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">s2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)))</span>

<span class="n">s4</span> <span class="o">=</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="n">s2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">s4</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)))</span>

<span class="n">s6</span> <span class="o">=</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="n">s2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">s6</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)))</span>

<span class="n">s6</span> <span class="o">=</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="n">s4</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">s6</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
True
True
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step with parameters (matched signatures)</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">q</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">gn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.094304e-01, 8.841961e-02], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step with parameters (pass fixed parameters)</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">q</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">gn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">],</span> <span class="n">parameters</span><span class="o">=</span><span class="p">[[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="p">[]])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.094304e-01, 8.841961e-02], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step can be differentiated with respect to initials, time step and/or parametes</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">q</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">gn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="c1"># Derivative with respect to initial</span>

<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">]),</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Derivative with respect to time step</span>

<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">]),</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[tensor([1.094304e-01, 8.841961e-02], dtype=torch.float64), tensor([[9.939735e-01, 9.979712e-02],
        [-1.207179e-01, 9.939427e-01]], dtype=torch.float64)]

[tensor([1.094304e-01, 8.841961e-02], dtype=torch.float64), tensor([8.841321e-02, -1.214017e-01], dtype=torch.float64)]
[[tensor([1.094304e-01, 8.841961e-02], dtype=torch.float64), tensor([8.841321e-02, -1.214017e-01], dtype=torch.float64)]]

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For derivative table propagation all knobs should be vectors</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">q</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">gn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">step</span> <span class="o">=</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">wrapper</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span>
                <span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]),</span>
                <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span>
                <span class="n">wrapper</span><span class="p">)</span>

<span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">+</span><span class="mf">0.001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">+</span><span class="mf">0.005</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">da</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">0.001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">+</span><span class="mf">0.001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">wrapper</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">da</span><span class="p">,</span> <span class="n">b</span> <span class="o">+</span> <span class="n">db</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">db</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.094304e-01, 8.841961e-02], dtype=torch.float64)
tensor([1.094304e-01, 8.841961e-02], dtype=torch.float64)

tensor([1.139844e-01, 8.272697e-02], dtype=torch.float64)
tensor([1.139846e-01, 8.272929e-02], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given a step, its derivatives can be used as a taylor model</span>
<span class="c1"># Note, taylor model is not symplectic in general</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">q</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">gn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">])(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">]),</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">[</span><span class="n">dx</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">]),</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">[</span><span class="n">dx</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">]),</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">[</span><span class="n">dx</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">]),</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">[</span><span class="n">dx</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">yoshida</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">fn</span><span class="p">,</span> <span class="n">gn</span><span class="p">]),</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">[</span><span class="n">dx</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.094303556041e-01, 8.841960703680e-02], dtype=torch.float64)
tensor([1.988014274981e-01, -2.394392236666e-02], dtype=torch.float64)

tensor([1.988479888736e-01, -2.304645602610e-02], dtype=torch.float64)
tensor([1.988014166220e-01, -2.394421962623e-02], dtype=torch.float64)
tensor([1.988014274804e-01, -2.394392240255e-02], dtype=torch.float64)
tensor([1.988014274981e-01, -2.394392236643e-02], dtype=torch.float64)
tensor([1.988014274981e-01, -2.394392236666e-02], dtype=torch.float64)

</pre></div></div>
</div>
</section>
<section id="Example-23:-Direct-invariant">
<h1>Example-23: Direct invariant<a class="headerlink" href="#Example-23:-Direct-invariant" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this example Taylor invariants are constructed by solving I(f(x)) = I(x) order-by-order</span>
<span class="c1"># Mapping f(x) can be replaced with its derivative table representation of a given order n</span>
<span class="c1"># Or mapping can be used directly</span>
<span class="c1"># Invariant of order n+1 can be computed</span>
<span class="c1"># Note, to avoid trivial solution, initial invariant guess should be provided, e.g. linear part invariant</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.invariant</span> <span class="kn">import</span> <span class="n">invariant</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">transport</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">map_01_02</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define one-turn transport</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set evaluation point</span>

<span class="c1"># Note, zero is a fixed point and derivatives with respect to parameters are not used, i.e. no need to compute paraetric fixed point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate derivative table representation for given order</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[],</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute linear normalization matrix</span>

<span class="n">_</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="n">x</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set initial invariants</span>

<span class="k">def</span> <span class="nf">ix</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">x</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">px</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">iy</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">x</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">qy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">py</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check conservation of linear invariants</span>

<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[],</span> <span class="n">ix</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[],</span> <span class="n">iy</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[ 6.775970e-02, -1.148888e-15,  0.000000e+00,  0.000000e+00],
        [-1.148888e-15,  1.475804e+01,  0.000000e+00,  0.000000e+00],
        [ 0.000000e+00,  0.000000e+00,  0.000000e+00,  0.000000e+00],
        [ 0.000000e+00,  0.000000e+00,  0.000000e+00,  0.000000e+00]], dtype=torch.float64)
tensor([[ 6.775970e-02, -1.151856e-15,  0.000000e+00,  0.000000e+00],
        [-1.151856e-15,  1.475804e+01,  0.000000e+00,  0.000000e+00],
        [ 0.000000e+00,  0.000000e+00,  0.000000e+00,  0.000000e+00],
        [ 0.000000e+00,  0.000000e+00,  0.000000e+00,  0.000000e+00]], dtype=torch.float64)

tensor([[0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00],
        [0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00],
        [0.000000e+00, 0.000000e+00, 8.242765e-02, 1.472561e-15],
        [0.000000e+00, 0.000000e+00, 1.472561e-15, 1.213185e+01]], dtype=torch.float64)
tensor([[0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00],
        [0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00],
        [0.000000e+00, 0.000000e+00, 8.242765e-02, 1.554312e-15],
        [0.000000e+00, 0.000000e+00, 1.554312e-15, 1.213185e+01]], dtype=torch.float64)

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute nonlinear invariants</span>
<span class="c1"># Note, computation is not optimized and requires a lot of memory</span>

<span class="n">tx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">invariant</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[],</span> <span class="n">ix</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0E-3</span><span class="p">)</span>
<span class="n">ty</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">invariant</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[],</span> <span class="n">iy</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0E-3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate and plot trajectory</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">bag</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2048</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">bag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">bag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">bag</span><span class="p">)</span>
<span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">bag</span><span class="o">.</span><span class="n">T</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">qx</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">px</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">qy</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">py</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_274_0.png" src="../_images/examples_ndtorch_274_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1st invariant conservation</span>
<span class="c1"># Note, for different initial conditions higher order invariants can give worse results</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">]):</span>
    <span class="n">sx</span> <span class="o">=</span> <span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="p">),</span> <span class="n">tx</span><span class="p">)</span>
    <span class="n">vx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]))(</span><span class="n">bag</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">vx</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vx</span><span class="p">)),</span> <span class="n">vx</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor(6.939136e-07, dtype=torch.float64)
tensor(8.133688e-08, dtype=torch.float64)

tensor(7.033768e-07, dtype=torch.float64)
tensor(2.919483e-09, dtype=torch.float64)

tensor(7.008737e-07, dtype=torch.float64)
tensor(1.419347e-09, dtype=torch.float64)

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_275_1.png" src="../_images/examples_ndtorch_275_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 2nd invariant conservation</span>
<span class="c1"># Note, for different initial conditions higher order invariants can give worse results</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">]):</span>
    <span class="n">sy</span> <span class="o">=</span> <span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="p">),</span> <span class="n">ty</span><span class="p">)</span>
    <span class="n">vy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">sy</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]))(</span><span class="n">bag</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">vy</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">vy</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vy</span><span class="p">)),</span> <span class="n">vy</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor(1.222613e-06, dtype=torch.float64)
tensor(1.538842e-07, dtype=torch.float64)

tensor(1.200414e-06, dtype=torch.float64)
tensor(7.017794e-09, dtype=torch.float64)

tensor(1.206937e-06, dtype=torch.float64)
tensor(3.553736e-09, dtype=torch.float64)

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_276_1.png" src="../_images/examples_ndtorch_276_1.png" />
</div>
</div>
</section>
<section id="Example-24:-Direct-invariant-(parametric)">
<h1>Example-24: Direct invariant (parametric)<a class="headerlink" href="#Example-24:-Direct-invariant-(parametric)" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.util</span> <span class="kn">import</span> <span class="n">first</span>
<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">split</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.invariant</span> <span class="kn">import</span> <span class="n">invariant</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">ksf</span><span class="p">,</span> <span class="n">ksd</span><span class="p">,</span> <span class="n">ksb</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">ksf</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span> <span class="o">+</span> <span class="n">ksb</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">ksd</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">ksd</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span> <span class="o">+</span> <span class="n">ksb</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">ksf</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">transport</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">map_01_02</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define one-turn transport</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find fixed point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fodo</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set computation orders</span>

<span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">nk</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find parametric fixed point</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">nw</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test parametric fixed point</span>
<span class="c1"># Note, if fp is not zero, redefine one-turn transport to map zero to zero</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">fodo</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a fodo variant around parametric fixed point</span>

<span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute derivative table representation</span>

<span class="c1"># Note, no parametric part should be passed, parametric zero is transformed to parametric zero</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">mapping</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64), tensor([[0., 0., 0.],
        [0., 0., 0.],
        [0., 0., 0.],
        [0., 0., 0.]], dtype=torch.float64)], [tensor([[0.],
        [0.],
        [0.],
        [0.]], dtype=torch.float64), tensor([[[0.],
         [0.],
         [0.]],

        [[0.],
         [0.],
         [0.]],

        [[0.],
         [0.],
         [0.]],

        [[0.],
         [0.],
         [0.]]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric normalization matrix</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">fp</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span>

<span class="n">tn</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="n">nw</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">fn</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set initial invariants</span>

<span class="k">def</span> <span class="nf">ix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">]))</span> <span class="o">@</span> <span class="n">x</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">px</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">iy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">]))</span> <span class="o">@</span> <span class="n">x</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">qy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">py</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1st invariant</span>

<span class="n">tx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">invariant</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">ix</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">_</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 2nd invariant</span>

<span class="n">ty</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">invariant</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">iy</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">_</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test conservation</span>

<span class="c1"># Note, here propagate is used as composition</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">tx</span><span class="p">),</span> <span class="n">tx</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">ty</span><span class="p">),</span> <span class="n">ty</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Series representation</span>
<span class="c1"># Note, generalized monomial is qx px qy py w ksf ksd ksb</span>

<span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">clean</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">tx</span><span class="p">)))</span>
<span class="n">s</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{(2, 0, 0, 0, 0, 0, 0, 0): tensor(3.387985e-02, dtype=torch.float64),
 (0, 2, 0, 0, 0, 0, 0, 0): tensor(7.379018e+00, dtype=torch.float64),
 (2, 0, 0, 0, 0, 1, 0, 0): tensor(-6.047879e-03, dtype=torch.float64),
 (2, 0, 0, 0, 0, 0, 1, 0): tensor(-6.517039e-03, dtype=torch.float64),
 (0, 2, 0, 0, 0, 1, 0, 0): tensor(1.317226e+00, dtype=torch.float64),
 (0, 2, 0, 0, 0, 0, 1, 0): tensor(1.419409e+00, dtype=torch.float64),
 (2, 0, 0, 0, 1, 0, 0, 0): tensor(1.994743e-01, dtype=torch.float64),
 (0, 2, 0, 0, 1, 0, 0, 0): tensor(-4.344542e+01, dtype=torch.float64),
 (2, 0, 0, 0, 1, 1, 0, 0): tensor(-6.188913e-02, dtype=torch.float64),
 (2, 0, 0, 0, 1, 0, 1, 0): tensor(-8.813844e-02, dtype=torch.float64),
 (2, 0, 0, 0, 1, 0, 0, 1): tensor(6.534032e-01, dtype=torch.float64),
 (0, 2, 0, 0, 1, 1, 0, 0): tensor(-2.031422e+00, dtype=torch.float64),
 (0, 2, 0, 0, 1, 0, 1, 0): tensor(2.482422e+00, dtype=torch.float64),
 (0, 2, 0, 0, 1, 0, 0, 1): tensor(-1.423110e+02, dtype=torch.float64),
 (3, 0, 0, 0, 0, 0, 0, 0): tensor(5.742237e-02, dtype=torch.float64),
 (1, 2, 0, 0, 0, 0, 0, 0): tensor(7.908874e+00, dtype=torch.float64),
 (1, 0, 2, 0, 0, 0, 0, 0): tensor(-1.249413e+00, dtype=torch.float64),
 (1, 0, 0, 2, 0, 0, 0, 0): tensor(8.887557e+01, dtype=torch.float64),
 (0, 1, 1, 1, 0, 0, 0, 0): tensor(-2.613173e+02, dtype=torch.float64),
 (3, 0, 0, 0, 0, 1, 0, 0): tensor(-2.180292e-02, dtype=torch.float64),
 (3, 0, 0, 0, 0, 0, 1, 0): tensor(-3.543561e-02, dtype=torch.float64),
 (3, 0, 0, 0, 0, 0, 0, 1): tensor(2.292041e-01, dtype=torch.float64),
 (1, 2, 0, 0, 0, 1, 0, 0): tensor(7.152281e+00, dtype=torch.float64),
 (1, 2, 0, 0, 0, 0, 1, 0): tensor(1.584743e+01, dtype=torch.float64),
 (1, 2, 0, 0, 0, 0, 0, 1): tensor(1.861577e+01, dtype=torch.float64),
 (1, 0, 2, 0, 0, 1, 0, 0): tensor(-7.509155e-01, dtype=torch.float64),
 (1, 0, 2, 0, 0, 0, 1, 0): tensor(-1.639441e+00, dtype=torch.float64),
 (1, 0, 2, 0, 0, 0, 0, 1): tensor(-5.148461e+00, dtype=torch.float64),
 (1, 0, 0, 2, 0, 1, 0, 0): tensor(6.392325e+01, dtype=torch.float64),
 (1, 0, 0, 2, 0, 0, 1, 0): tensor(1.341707e+02, dtype=torch.float64),
 (1, 0, 0, 2, 0, 0, 0, 1): tensor(3.638539e+02, dtype=torch.float64),
 (0, 1, 1, 1, 0, 1, 0, 0): tensor(-2.452915e+02, dtype=torch.float64),
 (0, 1, 1, 1, 0, 0, 1, 0): tensor(-4.911196e+02, dtype=torch.float64),
 (0, 1, 1, 1, 0, 0, 0, 1): tensor(-1.064586e+03, dtype=torch.float64),
 (3, 0, 0, 0, 1, 0, 0, 0): tensor(-5.835809e-01, dtype=torch.float64),
 (1, 2, 0, 0, 1, 0, 0, 0): tensor(6.243185e+01, dtype=torch.float64),
 (1, 0, 2, 0, 1, 0, 0, 0): tensor(1.617990e+02, dtype=torch.float64),
 (1, 0, 0, 2, 1, 0, 0, 0): tensor(-1.601207e+04, dtype=torch.float64),
 (0, 1, 1, 1, 1, 0, 0, 0): tensor(4.860999e+04, dtype=torch.float64),
 (3, 0, 0, 0, 1, 1, 0, 0): tensor(-8.770463e-02, dtype=torch.float64),
 (3, 0, 0, 0, 1, 0, 1, 0): tensor(-4.631656e-01, dtype=torch.float64),
 (3, 0, 0, 0, 1, 0, 0, 1): tensor(-4.557887e+00, dtype=torch.float64),
 (1, 2, 0, 0, 1, 1, 0, 0): tensor(9.372351e+01, dtype=torch.float64),
 (1, 2, 0, 0, 1, 0, 1, 0): tensor(1.993612e+02, dtype=torch.float64),
 (1, 2, 0, 0, 1, 0, 0, 1): tensor(5.704250e+02, dtype=torch.float64),
 (1, 0, 2, 0, 1, 1, 0, 0): tensor(2.404182e+02, dtype=torch.float64),
 (1, 0, 2, 0, 1, 0, 1, 0): tensor(5.584620e+02, dtype=torch.float64),
 (1, 0, 2, 0, 1, 0, 0, 1): tensor(1.295549e+03, dtype=torch.float64),
 (1, 0, 0, 2, 1, 1, 0, 0): tensor(-2.229816e+04, dtype=torch.float64),
 (1, 0, 0, 2, 1, 0, 1, 0): tensor(-5.022342e+04, dtype=torch.float64),
 (1, 0, 0, 2, 1, 0, 0, 1): tensor( -1.279140e+05, dtype=torch.float64),
 (0, 1, 1, 1, 1, 1, 0, 0): tensor(7.791695e+04, dtype=torch.float64),
 (0, 1, 1, 1, 1, 0, 1, 0): tensor( 1.680246e+05, dtype=torch.float64),
 (0, 1, 1, 1, 1, 0, 0, 1): tensor( 3.876573e+05, dtype=torch.float64)}
</pre></div></div>
</div>
</section>
<section id="Example-25:-Composition">
<h1>Example-25: Composition<a class="headerlink" href="#Example-25:-Composition" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this example the following homomorphism is illustrated</span>
<span class="c1"># t(f o g) = t(f) o t(g)</span>
<span class="c1"># Meaning, table of composition is equal to composition of tables</span>
<span class="c1"># Mappings f and g that map zero to zero, i.e. are without constant part</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">map_02_03</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set computation order &amp; evaluation point</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note, both mapping map zero to zero</span>
<span class="c1"># Also, parameters that effect closed orbit are not used</span>

<span class="nb">print</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">map_02_03</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Direct table generation</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">map_02_03</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagation of identity (equvalent to direct table generation)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">map_02_03</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagation (split)</span>

<span class="c1"># Table is propagated through mappings</span>
<span class="c1"># Note, this evaluation is inherently sequential</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[],</span> <span class="n">map_01_02</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[],</span> <span class="n">map_02_03</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Composition</span>

<span class="c1"># Note, given an evaluation point (e.g. closed orbit at each element)</span>
<span class="c1"># Identity can be propagated (or just perform direct computation) for each element</span>
<span class="c1"># This can significantly reduce computation cost</span>

<span class="c1"># Note, evaluations of t_01_02 and t_02_03 are independent and can be performed in parallel</span>
<span class="c1"># Also, propagation of table through table might be computationally less expensive</span>

<span class="n">t_01_02</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="n">t_01_02</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">t_01_02</span><span class="p">,</span> <span class="p">[],</span> <span class="n">map_01_02</span><span class="p">)</span>

<span class="n">t_02_03</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="n">t_02_03</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">t_02_03</span><span class="p">,</span> <span class="p">[],</span> <span class="n">map_02_03</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">t_01_02</span><span class="p">,</span> <span class="p">[],</span> <span class="n">t_02_03</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
</section>
<section id="Example-26:-Composition-(closed-orbit)">
<h1>Example-26: Composition (closed orbit)<a class="headerlink" href="#Example-26:-Composition-(closed-orbit)" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Composition illustration with non-zero closed orbit</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.util</span> <span class="kn">import</span> <span class="n">first</span>
<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="c1"># Note, kick is used to generate non-zero (dynamical) closed orbit</span>
<span class="c1"># Momentum deviation is used as a parameter (coupled to closed orbit via dispersion)</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.0E-4</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0E-4</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">map_02_03</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find (dynamical) fixed point</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_02_03</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">w</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Check fixed point</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">map_02_03</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">w</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([ 8.418072943377e-04, -5.000000000000e-05, -2.043309959087e-03,
         5.000000000000e-05], dtype=torch.float64)
tensor([ 8.418072943377e-04, -5.000000000000e-05, -2.043309959087e-03,
         5.000000000000e-05], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set computation orders for state and each knob group</span>

<span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find parametric fixed point</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">nw</span><span class="p">,</span> <span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_02_03</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">w</span><span class="p">))</span>

<span class="c1"># Check</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_02_03</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">w</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set parametric fixed points at each map entrance</span>

<span class="n">pfp_01</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span> <span class="n">parametric</span><span class="o">=</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">pfp_02</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">pfp_01</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">map_01_02</span><span class="p">)</span>

<span class="c1"># Check</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">pfp_01</span><span class="p">,</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">pfp_01</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_02_03</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">w</span><span class="p">))))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">pfp_02</span><span class="p">,</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">pfp_02</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">map_02_03</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">w</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define transformations around parametric fixed points</span>

<span class="c1"># Note, this transformation map zero (parametric) state to zero (upto given order)</span>
<span class="c1"># This is true by construction</span>

<span class="k">def</span> <span class="nf">fn_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp_01</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">]),</span> <span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp_02</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">fn_02_03</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">map_02_03</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp_02</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">]),</span> <span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp_01</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">identity</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">]),</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">fn_01_02</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64), tensor([[0.],
        [0.],
        [0.],
        [0.]], dtype=torch.float64), tensor([[[0.]],

        [[0.]],

        [[0.]],

        [[0.]]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Propagate identity sequentially</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span> <span class="n">parametric</span><span class="o">=</span><span class="n">pfp</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_02_03</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Composition</span>

<span class="c1"># Note, parametric part is zero, other elements of t should be equal to corresponding elements of T</span>

<span class="n">t_01_02</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span>
<span class="n">t_01_02</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">t_01_02</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">fn_01_02</span><span class="p">)</span>

<span class="n">t_02_03</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span>
<span class="n">t_02_03</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">t_02_03</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">fn_02_03</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">t_01_02</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">t_02_03</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare phase space trajectories</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">qx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">px</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">qx</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0E-12</span>
<span class="n">qy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">qx</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0E-03</span>
<span class="n">py</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">qx</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0E-12</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0E-3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">map_02_03</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">w</span><span class="p">))(</span><span class="n">y</span><span class="p">)</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">table</span>
<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qx</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">px</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>


<span class="n">count</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">]))(</span><span class="n">y</span><span class="p">)</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">table</span>
<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qx</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">px</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>


<span class="n">count</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">]))(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">])</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">table</span>
<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qx</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">px</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_321_0.png" src="../_images/examples_ndtorch_321_0.png" />
</div>
</div>
</section>
<section id="Example-27:-Inverse">
<h1>Example-27: Inverse<a class="headerlink" href="#Example-27:-Inverse" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.inverse</span> <span class="kn">import</span> <span class="n">inverse</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set computation order &amp; evaluation point</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute derivative table</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute inverse</span>

<span class="n">t_inv</span> <span class="o">=</span> <span class="n">inverse</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[],</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">t_inv</span><span class="p">,</span> <span class="p">[],</span> <span class="n">t</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[],
 tensor([[1.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00],
         [0.000000000000e+00, 1.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00],
         [0.000000000000e+00, 0.000000000000e+00, 1.000000000000e+00, 0.000000000000e+00],
         [0.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00, 1.000000000000e+00]],
        dtype=torch.float64),
 [],
 []]
</pre></div></div>
</div>
</section>
<section id="Example-28:-Inverse-(closed-orbit)">
<h1>Example-28: Inverse (closed orbit)<a class="headerlink" href="#Example-28:-Inverse-(closed-orbit)" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.util</span> <span class="kn">import</span> <span class="n">first</span>
<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.inverse</span> <span class="kn">import</span> <span class="n">inverse</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.0E-4</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0E-4</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find (dynamical) fixed point</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Check fixed point</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([ 8.418072943377e-04, -5.000000000000e-05, -2.043309959087e-03,
         5.000000000000e-05], dtype=torch.float64)
tensor([ 8.418072943377e-04, -5.000000000000e-05, -2.043309959087e-03,
         5.000000000000e-05], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set computation orders for state and each knob group</span>

<span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find parametric fixed point</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">nw</span><span class="p">,</span> <span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>

<span class="c1"># Check</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define transformations around parametric fixed points</span>

<span class="c1"># Note, this transformation map zero (parametric) state to zero (upto given order)</span>
<span class="c1"># This is true by construction</span>

<span class="k">def</span> <span class="nf">fn_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">]),</span> <span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">])</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">identity</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">]),</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">fn_01_02</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[[], [], []]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute derivative table</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">fn_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute inverse</span>

<span class="n">t_inv</span> <span class="o">=</span> <span class="n">inverse</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">t_inv</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[[], [], []],
 [tensor([[1.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00],
          [0.000000000000e+00, 1.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00],
          [0.000000000000e+00, 0.000000000000e+00, 1.000000000000e+00, 0.000000000000e+00],
          [0.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00, 1.000000000000e+00]],
         dtype=torch.float64),
  [],
  []],
 [[], [], []],
 [[], [], []]]
</pre></div></div>
</div>
</section>
<section id="Example-29:-Momenta-generator">
<h1>Example-29: Momenta generator<a class="headerlink" href="#Example-29:-Momenta-generator" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this example initial and final monemta are computed from given initial and final coordinates</span>
<span class="c1"># Given an origing preserving mapping, its table representation can be computed upto some order</span>
<span class="c1"># This representation can be considered as exact</span>
<span class="c1"># Next, given initial and final coordinates, corresponding momenta can be computed using momenta generator</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.util</span> <span class="kn">import</span> <span class="n">first</span>
<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.momenta</span> <span class="kn">import</span> <span class="n">momenta</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.0E-4</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0E-4</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find (dynamical) fixed point</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Check fixed point</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">map_01_02</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([ 8.418072943377e-04, -5.000000000000e-05, -2.043309959087e-03,
         5.000000000000e-05], dtype=torch.float64)
tensor([ 8.418072943377e-04, -5.000000000000e-05, -2.043309959087e-03,
         5.000000000000e-05], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set computation orders for state and each knob group</span>

<span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find parametric fixed point</span>

<span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="n">nw</span><span class="p">,</span> <span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>

<span class="c1"># Check</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">pfp</span><span class="p">,</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define transformations around parametric fixed points</span>

<span class="c1"># Note, this transformation map zero (parametric) state to zero (upto given order)</span>
<span class="c1"># This is true by construction</span>

<span class="k">def</span> <span class="nf">fn_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">map_01_02</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">]),</span> <span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">pfp</span><span class="p">),</span> <span class="p">[</span><span class="n">w</span><span class="p">])</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">identity</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">]),</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">fn_01_02</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[tensor([0., 0., 0., 0.], dtype=torch.float64),
  tensor([[0.],
          [0.],
          [0.],
          [0.]], dtype=torch.float64),
  tensor([[[0.]],

          [[0.]],

          [[0.]],

          [[0.]]], dtype=torch.float64)]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute derivative table</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">fn_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute momenta generator</span>

<span class="c1"># Note, computation order can be different from that of the input table</span>
<span class="c1"># Accuracy is strongly related to computation order and magnitude of initial coordinates</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">momenta</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Recover momenta from coordinates</span>

<span class="c1"># Set deviations</span>

<span class="n">xi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0005</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0005</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">dw</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Evaluate final state using table representation</span>

<span class="n">xf</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="n">dw</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">xf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Set initial and final coordinates</span>

<span class="n">qi</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">xi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">qf</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">xf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">qs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">qf</span><span class="p">,</span> <span class="n">qi</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Set initial and final momenta</span>

<span class="n">_</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="o">=</span> <span class="n">xi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">_</span><span class="p">,</span> <span class="n">pf</span><span class="p">,</span> <span class="o">=</span> <span class="n">xf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">pf</span><span class="p">,</span> <span class="n">pi</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Evaluate generator using coordinates</span>

<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="n">qs</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="n">dw</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="n">qs</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">dw</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([ 1.536782226285e-03, -2.360460895977e-05, -1.128298475344e-03,
        -6.800430927953e-05], dtype=torch.float64)

tensor([1.536782226285e-03, -1.128298475344e-03, 5.000000000000e-04, -5.000000000000e-04],
       dtype=torch.float64)

tensor([-2.360460895977e-05, -6.800430927953e-05,  1.000000000000e-04,
        -1.000000000000e-04], dtype=torch.float64)

tensor([-2.353065307569e-05, -6.780339520304e-05,  9.993585406462e-05,
        -1.001716171999e-04], dtype=torch.float64)
tensor([-2.360460892419e-05, -6.800430928312e-05,  9.999999996933e-05,
        -1.000000000050e-04], dtype=torch.float64)
</pre></div></div>
</div>
</section>
<section id="Example-30:-Factorization-(kick)">
<h1>Example-30: Factorization (kick)<a class="headerlink" href="#Example-30:-Factorization-(kick)" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given a derivative table representation (taylor series) of an origin preserving mapping</span>
<span class="c1"># It is possible to factorize it into composition of linear and nonlinear table representations</span>
<span class="c1"># If original mapping represents a single turn, linear part can be brought to its normal form</span>
<span class="c1"># This can be done using linear theory</span>
<span class="c1"># The nonlinear part is a near identity transformation, it can be represented with Lie transformation</span>
<span class="c1"># t = tl o tn and tn = exp(-[h])</span>
<span class="c1"># In this example (generator) h is computed for a single kick</span>
<span class="c1"># It can be used to construct nonlinear normal forms or as a redundancy free representation</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">ndtorch.taylor</span> <span class="kn">import</span> <span class="n">taylor</span>
<span class="kn">from</span> <span class="nn">ndtorch.inverse</span> <span class="kn">import</span> <span class="n">inverse</span>
<span class="kn">from</span> <span class="nn">ndtorch.factorization</span> <span class="kn">import</span> <span class="n">hamiltonian</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transformation</span>

<span class="c1"># Note, this transformation can be exactly represented with a taylor series (i.e. polynomial)</span>

<span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
    <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="c1"># Test origin propagation</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute table representation</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare for some deviation</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">dk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mapping</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">dk</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dk</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.009811250000e-01, 9.622500000000e-03, 5.102537625000e-02, 1.050752500000e-02],
       dtype=torch.float64)
tensor([1.009811250000e-01, 9.622500000000e-03, 5.102537625000e-02, 1.050752500000e-02],
       dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Linear part is not near identity</span>

<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[1.000000000000e+00, 1.000000000000e-01, 0.000000000000e+00, 0.000000000000e+00],
        [0.000000000000e+00, 1.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00],
        [0.000000000000e+00, 0.000000000000e+00, 1.000000000000e+00, 1.000000000000e-01],
        [0.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00, 1.000000000000e+00]],
       dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set linear part and compose with its inverse</span>

<span class="n">l</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">inverse</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">l</span><span class="p">),</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Now table represents a near identity transformation</span>

<span class="nb">print</span><span class="p">(</span><span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[1.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00],
        [0.000000000000e+00, 1.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00],
        [0.000000000000e+00, 0.000000000000e+00, 1.000000000000e+00, 0.000000000000e+00],
        [0.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00, 1.000000000000e+00]],
       dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute single exponent generator</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">hamiltonian</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

<span class="c1"># Compute series representation</span>

<span class="c1"># Note, each coefficient is proportional to strength</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">clean</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">h</span><span class="p">))</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(3, 0, 0, 0, 1) tensor(1.666666666667e-02, dtype=torch.float64)
(2, 1, 0, 0, 1) tensor(-2.500000000000e-03, dtype=torch.float64)
(1, 2, 0, 0, 1) tensor(1.250000000000e-04, dtype=torch.float64)
(1, 0, 2, 0, 1) tensor(-5.000000000000e-02, dtype=torch.float64)
(1, 0, 1, 1, 1) tensor(5.000000000000e-03, dtype=torch.float64)
(1, 0, 0, 2, 1) tensor(-1.250000000000e-04, dtype=torch.float64)
(0, 3, 0, 0, 1) tensor(-2.083333333333e-06, dtype=torch.float64)
(0, 1, 2, 0, 1) tensor(2.500000000000e-03, dtype=torch.float64)
(0, 1, 1, 1, 1) tensor(-2.500000000000e-04, dtype=torch.float64)
(0, 1, 0, 2, 1) tensor(6.250000000000e-06, dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this example, this hamiltonian generates exact solution with taylor intergator</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mapping</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">dk</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">taylor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">]),</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dk</span><span class="p">]),</span> <span class="n">dk</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.009811250000e-01, 9.622500000000e-03, 5.102537625000e-02, 1.050752500000e-02],
       dtype=torch.float64)
tensor([1.009811250000e-01, 9.622500000000e-03, 5.102537625000e-02, 1.050752500000e-02],
       dtype=torch.float64)
</pre></div></div>
</div>
</section>
<section id="Example-31:-Factorization-(fodo)">
<h1>Example-31: Factorization (fodo)<a class="headerlink" href="#Example-31:-Factorization-(fodo)" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">ndtorch.taylor</span> <span class="kn">import</span> <span class="n">taylor</span>
<span class="kn">from</span> <span class="nn">ndtorch.inverse</span> <span class="kn">import</span> <span class="n">inverse</span>
<span class="kn">from</span> <span class="nn">ndtorch.factorization</span> <span class="kn">import</span> <span class="n">hamiltonian</span>
<span class="kn">from</span> <span class="nn">ndtorch.factorization</span> <span class="kn">import</span> <span class="n">solution</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set fodo</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set computation order &amp; evaluation point</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Note, origin is preserved</span>

<span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0., 0., 0., 0.], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute derivative table</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="p">[],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set linear part</span>

<span class="n">l</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="n">x</span><span class="p">)</span>
<span class="n">l</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[tensor([0., 0., 0., 0.], dtype=torch.float64),
 tensor([[8.259928915375e-02, 1.470387298165e+01, 0.000000000000e+00, 0.000000000000e+00],
         [-6.754528950779e-02, 8.259928915375e-02, 0.000000000000e+00, 0.000000000000e+00],
         [0.000000000000e+00, 0.000000000000e+00, 8.239443265215e-01, 6.857644998910e+00],
         [0.000000000000e+00, 0.000000000000e+00, -4.682595072274e-02, 8.239443265215e-01]],
        dtype=torch.float64)]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set nonlinear part</span>

<span class="n">u</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">inverse</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="p">[],</span> <span class="n">l</span><span class="p">),</span> <span class="p">[],</span> <span class="n">t</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<span class="n">derivative</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[tensor([0., 0., 0., 0.], dtype=torch.float64),
 tensor([[1.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00],
         [0.000000000000e+00, 1.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00],
         [0.000000000000e+00, 0.000000000000e+00, 1.000000000000e+00, 0.000000000000e+00],
         [0.000000000000e+00, 0.000000000000e+00, 0.000000000000e+00, 1.000000000000e+00]],
        dtype=torch.float64)]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute hamiltonian</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">hamiltonian</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[],</span> <span class="n">u</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute series representation</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">clean</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">h</span><span class="p">),</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0E-9</span><span class="p">)</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(3, 0, 0, 0) tensor(5.024988945080e-02, dtype=torch.float64)
(2, 1, 0, 0) tensor(-8.027849817894e-01, dtype=torch.float64)
(1, 2, 0, 0) tensor(1.242554019904e+01, dtype=torch.float64)
(1, 0, 2, 0) tensor(-5.976214487541e-01, dtype=torch.float64)
(1, 0, 1, 1) tensor(3.719621673904e+00, dtype=torch.float64)
(1, 0, 0, 2) tensor(-6.659517059512e+00, dtype=torch.float64)
(0, 3, 0, 0) tensor(-1.465736828313e+02, dtype=torch.float64)
(0, 1, 2, 0) tensor(7.616595688746e+00, dtype=torch.float64)
(0, 1, 1, 1) tensor(-6.812652464723e+01, dtype=torch.float64)
(0, 1, 0, 2) tensor(1.637189795764e+02, dtype=torch.float64)
(4, 0, 0, 0) tensor(-2.670453079972e-02, dtype=torch.float64)
(3, 1, 0, 0) tensor(1.592046859279e+00, dtype=torch.float64)
(2, 2, 0, 0) tensor(-4.015290100155e+01, dtype=torch.float64)
(2, 0, 2, 0) tensor(1.098921583040e-02, dtype=torch.float64)
(2, 0, 1, 1) tensor(-1.150214563563e+00, dtype=torch.float64)
(2, 0, 0, 2) tensor(5.596016324538e+00, dtype=torch.float64)
(1, 3, 0, 0) tensor(2.720415502394e+02, dtype=torch.float64)
(1, 1, 2, 0) tensor(9.092563694884e+00, dtype=torch.float64)
(1, 1, 1, 1) tensor(-7.311435065924e+01, dtype=torch.float64)
(1, 1, 0, 2) tensor(1.043406910282e+02, dtype=torch.float64)
(0, 4, 0, 0) tensor(-8.872464473277e+02, dtype=torch.float64)
(0, 2, 2, 0) tensor(2.515413272498e+01, dtype=torch.float64)
(0, 2, 1, 1) tensor(6.993401944277e+01, dtype=torch.float64)
(0, 2, 0, 2) tensor(-3.593047920669e+02, dtype=torch.float64)
(0, 0, 4, 0) tensor(-1.258999636146e+00, dtype=torch.float64)
(0, 0, 3, 1) tensor(1.898846058062e+01, dtype=torch.float64)
(0, 0, 2, 2) tensor(-1.062500223737e+02, dtype=torch.float64)
(0, 0, 1, 3) tensor(2.608144282259e+02, dtype=torch.float64)
(0, 0, 0, 4) tensor(-2.419706859670e+02, dtype=torch.float64)
(5, 0, 0, 0) tensor(3.720153703396e-02, dtype=torch.float64)
(4, 1, 0, 0) tensor(-2.470046738149e+00, dtype=torch.float64)
(3, 2, 0, 0) tensor(5.465213020046e+01, dtype=torch.float64)
(3, 0, 2, 0) tensor(6.994399435987e-02, dtype=torch.float64)
(3, 0, 1, 1) tensor(-9.734770779462e-01, dtype=torch.float64)
(3, 0, 0, 2) tensor(5.509140066922e-01, dtype=torch.float64)
(2, 3, 0, 0) tensor(-7.728896235979e+02, dtype=torch.float64)
(2, 1, 2, 0) tensor(1.614402519455e+01, dtype=torch.float64)
(2, 1, 1, 1) tensor(-1.014114400601e+02, dtype=torch.float64)
(2, 1, 0, 2) tensor(2.099498728183e+02, dtype=torch.float64)
(1, 4, 0, 0) tensor(6.599464974629e+03, dtype=torch.float64)
(1, 2, 2, 0) tensor(-1.831472433171e+02, dtype=torch.float64)
(1, 2, 1, 1) tensor(1.658609587412e+03, dtype=torch.float64)
(1, 2, 0, 2) tensor(-4.455648121228e+03, dtype=torch.float64)
(1, 0, 4, 0) tensor(-2.372154036991e+00, dtype=torch.float64)
(1, 0, 3, 1) tensor(3.120364861986e+01, dtype=torch.float64)
(1, 0, 2, 2) tensor(-1.392873544053e+02, dtype=torch.float64)
(1, 0, 1, 3) tensor(2.280297561995e+02, dtype=torch.float64)
(1, 0, 0, 4) tensor(-5.830536198793e+01, dtype=torch.float64)
(0, 5, 0, 0) tensor(-1.712807218852e+04, dtype=torch.float64)
(0, 3, 2, 0) tensor(-5.278629070820e+02, dtype=torch.float64)
(0, 3, 1, 1) tensor(3.474912442117e+03, dtype=torch.float64)
(0, 3, 0, 2) tensor(1.999757814650e+02, dtype=torch.float64)
(0, 1, 4, 0) tensor(2.874466602579e+01, dtype=torch.float64)
(0, 1, 3, 1) tensor(-5.199961828427e+02, dtype=torch.float64)
(0, 1, 2, 2) tensor(3.267795295152e+03, dtype=torch.float64)
(0, 1, 1, 3) tensor(-8.677457594504e+03, dtype=torch.float64)
(0, 1, 0, 4) tensor(8.128231575922e+03, dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Restore mapping table nonlinear part from hamiltonian</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">solution</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[],</span> <span class="n">h</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span><span class="p">,</span> <span class="p">[],</span> <span class="n">solution</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[],</span> <span class="n">h</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
True
</pre></div></div>
</div>
</section>
<section id="Example-32:-Factorization-(factorize)">
<h1>Example-32: Factorization (factorize)<a class="headerlink" href="#Example-32:-Factorization-(factorize)" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">split</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.bracket</span> <span class="kn">import</span> <span class="n">bracket</span>
<span class="kn">from</span> <span class="nn">ndtorch.factorization</span> <span class="kn">import</span> <span class="n">hamiltonian</span>
<span class="kn">from</span> <span class="nn">ndtorch.factorization</span> <span class="kn">import</span> <span class="n">solution</span>
<span class="kn">from</span> <span class="nn">ndtorch.factorization</span> <span class="kn">import</span> <span class="n">factorize</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set test hamiltonian function and compute corresponding table representation</span>

<span class="c1"># Note, test hamiltonian is near identity</span>

<span class="k">def</span> <span class="nf">h</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">u</span><span class="p">,</span> <span class="o">=</span> <span class="n">u</span>
    <span class="n">v</span><span class="p">,</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">u</span> <span class="o">+</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">p</span><span class="o">**</span><span class="mi">4</span>
    <span class="n">h3</span> <span class="o">=</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">q</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="o">**</span><span class="mi">5</span>
    <span class="k">return</span> <span class="n">h1</span> <span class="o">+</span> <span class="n">h2</span> <span class="o">+</span> <span class="n">h3</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="n">chop</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">clean</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">h</span><span class="p">)))</span>
<span class="n">s</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{(3, 0, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (2, 1, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (1, 2, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (0, 3, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (3, 0, 1, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (3, 0, 2, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (4, 0, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (3, 1, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (2, 2, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (1, 3, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (0, 4, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (4, 0, 0, 1): tensor(1.000000000000e+00, dtype=torch.float64),
 (5, 0, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (4, 1, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (3, 2, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (2, 3, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (1, 4, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (0, 5, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64)}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute solution</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">solution</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute hamiltonian from solution and compare</span>

<span class="n">compare</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">hamiltonian</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform factorization</span>

<span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Examine series representation</span>

<span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">clean</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">h1</span><span class="p">)))</span>
<span class="n">s</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{(3, 0, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (2, 1, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (1, 2, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (0, 3, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (3, 0, 1, 0): tensor(1.000000000000e+00, dtype=torch.float64)}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Examine series representation</span>

<span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">clean</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">h2</span><span class="p">)))</span>
<span class="n">s</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{(4, 0, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (3, 1, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (2, 2, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (1, 3, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (0, 4, 0, 0): tensor(1.000000000000e+00, dtype=torch.float64),
 (4, 0, 0, 1): tensor(1.000000000000e+00, dtype=torch.float64)}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Examine series representation</span>

<span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">clean</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">h3</span><span class="p">)))</span>
<span class="n">s</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{(5, 0, 0, 0): tensor(5.000000000000e-01, dtype=torch.float64),
 (4, 1, 0, 0): tensor(-5.000000000000e-01, dtype=torch.float64),
 (3, 2, 0, 0): tensor(-2.000000000000e+00, dtype=torch.float64),
 (2, 3, 0, 0): tensor(4.000000000000e+00, dtype=torch.float64),
 (1, 4, 0, 0): tensor(2.500000000000e+00, dtype=torch.float64),
 (0, 5, 0, 0): tensor(1.500000000000e+00, dtype=torch.float64),
 (5, 0, 0, 1): tensor(-2.000000000000e+00, dtype=torch.float64),
 (4, 1, 0, 1): tensor(-4.000000000000e+00, dtype=torch.float64),
 (3, 2, 0, 1): tensor(-6.000000000000e+00, dtype=torch.float64),
 (5, 0, 1, 0): tensor(1.500000000000e+00, dtype=torch.float64),
 (4, 1, 1, 0): tensor(3.000000000000e+00, dtype=torch.float64),
 (3, 2, 1, 0): tensor(4.500000000000e+00, dtype=torch.float64),
 (2, 3, 1, 0): tensor(6.000000000000e+00, dtype=torch.float64)}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute solutions</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">solution</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">h1</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">solution</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">h2</span><span class="p">)</span>
<span class="n">t3</span> <span class="o">=</span> <span class="n">solution</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">h3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compose individual solutions and compare with initial solution</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">identity</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">])</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">t1</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">t2</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">t3</span><span class="p">)</span>
<span class="n">compare</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
</section>
<section id="Example-33:-Nonlinear-mapping-approximation-(gradient)">
<h1>Example-33: Nonlinear mapping approximation (gradient)<a class="headerlink" href="#Example-33:-Nonlinear-mapping-approximation-(gradient)" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.gradient</span> <span class="kn">import</span> <span class="n">series</span>
<span class="kn">from</span> <span class="nn">ndtorch.series</span> <span class="kn">import</span> <span class="n">clean</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set test mapping</span>
<span class="c1"># Rotation with two sextupoles separated by negative identity linear transformation</span>
<span class="c1"># Note, result is expected to have zero degree two coefficients due to negative identity linear transformation between sextupoles</span>

<span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="o">*</span><span class="n">mux</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">px</span><span class="o">*</span><span class="n">mux</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">px</span><span class="o">*</span><span class="n">mux</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">qx</span><span class="o">*</span><span class="n">mux</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">qy</span><span class="o">*</span><span class="n">muy</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">py</span><span class="o">*</span><span class="n">muy</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span> <span class="n">py</span><span class="o">*</span><span class="n">muy</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">qy</span><span class="o">*</span><span class="n">muy</span><span class="o">.</span><span class="n">sin</span><span class="p">()])</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">ring</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">spin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">spin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">muy</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set evaluation point</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Compute and print series</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">clean</span><span class="p">(</span><span class="n">series</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span> <span class="n">ring</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">retain</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0E-12</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">clean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0E-14</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1, 0, 0, 0): [0.55339155 0.83292124 0.         0.        ]
(0, 1, 0, 0): [-0.83292124  0.55339155  0.          0.        ]
(0, 0, 1, 0): [0.         0.         0.06279052 0.99802673]
(0, 0, 0, 1): [ 0.          0.         -0.99802673  0.06279052]
(3, 0, 0, 0): [-7.53257307e-09  2.82424677e-03 -0.00000000e+00 -0.00000000e+00]
(2, 1, 0, 0): [-1.96250238e-08 -1.27525063e-02 -0.00000000e+00 -0.00000000e+00]
(2, 0, 1, 0): [-0.00000000e+00 -0.00000000e+00  9.21186111e-06  3.34331441e-04]
(2, 0, 0, 1): [-0.00000000e+00 -0.00000000e+00  1.59704766e-05 -5.06941449e-03]
(1, 2, 0, 0): [-1.11004920e-08  1.91940679e-02 -0.00000000e+00 -0.00000000e+00]
(1, 1, 1, 0): [-0.00000000e+00 -0.00000000e+00 -2.98671134e-05 -9.79459005e-04]
(1, 1, 0, 1): [-0.00000000e+00 -0.00000000e+00 -1.48185697e-05  1.53623878e-02]
(1, 0, 2, 0): [-1.05857397e-06  1.97282603e-05 -0.00000000e+00 -0.00000000e+00]
(1, 0, 1, 1): [ 1.48154798e-05 -1.18570682e-03 -0.00000000e+00 -0.00000000e+00]
(1, 0, 0, 2): [ 2.88067554e-05  9.18409783e-03 -0.00000000e+00 -0.00000000e+00]
(0, 3, 0, 0): [-9.21338045e-10 -9.62979589e-03  0.00000000e+00  0.00000000e+00]
(0, 2, 1, 0): [0.00000000e+00 0.00000000e+00 2.40366928e-05 7.09979811e-04]
(0, 2, 0, 1): [ 0.00000000e+00  0.00000000e+00 -1.38786549e-05 -1.15294375e-02]
(0, 1, 2, 0): [ 1.80396305e-06 -2.59196622e-05  0.00000000e+00  0.00000000e+00]
(0, 1, 1, 1): [-2.98509155e-05  1.72488752e-03  0.00000000e+00  0.00000000e+00]
(0, 1, 0, 2): [ 1.66318846e-05 -1.38269522e-02  0.00000000e+00  0.00000000e+00]
(0, 0, 3, 0): [-0.00000000e+00 -0.00000000e+00 -1.47704279e-08  4.12534350e-06]
(0, 0, 2, 1): [-0.00000000e+00 -0.00000000e+00 -3.31103168e-09 -1.96719688e-04]
(0, 0, 1, 2): [-0.00000000e+00 -0.00000000e+00  3.93325786e-09  3.12683573e-03]
(0, 0, 0, 3): [ 0.00000000e+00  0.00000000e+00  2.56887204e-10 -1.65665408e-02]
(4, 0, 0, 0): [ 6.48869023e-07 -3.91844462e-06  0.00000000e+00  0.00000000e+00]
(3, 1, 0, 0): [-3.91685700e-06  1.51001133e-05  0.00000000e+00  0.00000000e+00]
(3, 0, 1, 0): [ 0.00000000e+00  0.00000000e+00 -4.36165465e-07  5.76316391e-06]
(3, 0, 0, 1): [0.00000000e+00 0.00000000e+00 6.56410859e-06 1.31668166e-05]
(2, 2, 0, 0): [ 8.85501662e-06 -1.48880894e-05  0.00000000e+00  0.00000000e+00]
(2, 1, 1, 0): [ 0.00000000e+00  0.00000000e+00  1.92232731e-06 -2.78183189e-05]
(2, 1, 0, 1): [ 0.00000000e+00  0.00000000e+00 -2.96894787e-05 -3.16635607e-05]
(2, 0, 2, 0): [1.81838643e-08 2.18816315e-06 0.00000000e+00 0.00000000e+00]
(2, 0, 1, 1): [-9.93314202e-07 -3.25277215e-05  0.00000000e+00  0.00000000e+00]
(2, 0, 0, 2): [ 7.67316422e-06 -2.51871510e-05  0.00000000e+00  0.00000000e+00]
(1, 3, 0, 0): [-8.88618620e-06 -4.33921249e-06  0.00000000e+00  0.00000000e+00]
(1, 2, 1, 0): [ 0.00000000e+00  0.00000000e+00 -2.81910856e-06  4.44963121e-05]
(1, 2, 0, 1): [0.00000000e+00 0.00000000e+00 4.47107608e-05 6.22767407e-06]
(1, 1, 2, 0): [-5.02653030e-08 -6.69892371e-06  0.00000000e+00  0.00000000e+00]
(1, 1, 1, 1): [2.90625131e-06 1.04277202e-04 0.00000000e+00 0.00000000e+00]
(1, 1, 0, 2): [-2.28808176e-05  2.60346923e-05  0.00000000e+00  0.00000000e+00]
(1, 0, 3, 0): [0.00000000e+00 0.00000000e+00 2.09236592e-09 3.51323891e-08]
(1, 0, 2, 1): [ 0.00000000e+00  0.00000000e+00 -6.41657941e-09 -1.78350571e-06]
(1, 0, 1, 2): [ 0.00000000e+00  0.00000000e+00 -6.10954936e-07  1.86435774e-05]
(1, 0, 0, 3): [ 0.00000000e+00  0.00000000e+00  3.05503037e-06 -5.00150901e-05]
(0, 4, 0, 0): [3.33982092e-06 8.88114110e-06 0.00000000e+00 0.00000000e+00]
(0, 3, 1, 0): [ 0.00000000e+00  0.00000000e+00  1.37553970e-06 -2.36217768e-05]
(0, 3, 0, 1): [ 0.00000000e+00  0.00000000e+00 -2.24184174e-05  1.77513110e-05]
(0, 2, 2, 0): [3.54703897e-08 5.11986525e-06 0.00000000e+00 0.00000000e+00]
(0, 2, 1, 1): [-2.15414781e-06 -8.31702815e-05  0.00000000e+00  0.00000000e+00]
(0, 2, 0, 2): [1.72952174e-05 1.78791226e-05 0.00000000e+00 0.00000000e+00]
(0, 1, 3, 0): [ 0.00000000e+00  0.00000000e+00 -3.32576455e-09 -2.16775859e-08]
(0, 1, 2, 1): [0.00000000e+00 0.00000000e+00 1.73891518e-08 1.32003603e-06]
(0, 1, 1, 2): [ 0.00000000e+00  0.00000000e+00  8.58583303e-07 -7.35197022e-06]
(0, 1, 0, 3): [ 0.00000000e+00  0.00000000e+00 -4.60205741e-06 -3.44817289e-05]
(0, 0, 4, 0): [-2.95410616e-10 -3.91436795e-10  0.00000000e+00  0.00000000e+00]
(0, 0, 3, 1): [ 1.72261161e-08 -3.76703368e-08  0.00000000e+00  0.00000000e+00]
(0, 0, 2, 2): [-3.76632244e-07  1.04173914e-06  0.00000000e+00  0.00000000e+00]
(0, 0, 1, 3): [ 3.81179356e-06 -5.44741177e-06  0.00000000e+00  0.00000000e+00]
(0, 0, 0, 4): [-1.51552013e-05 -3.46854944e-07  0.00000000e+00  0.00000000e+00]
</pre></div></div>
</div>
</section>
<section id="Example-34:-ORM-optics-correction">
<h1>Example-34: ORM optics correction<a class="headerlink" href="#Example-34:-ORM-optics-correction" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this example orbit responce matrix is used to correct linear optics</span>

<span class="c1"># This illustrates one optimization step</span>
<span class="c1"># Given a measured responce matrix, the model is fitted to reproduce it</span>
<span class="c1"># Next, the corrections should be applied and the matrix should be remeasured</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ndtorch.util</span> <span class="kn">import</span> <span class="n">first</span>
<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.signature</span> <span class="kn">import</span> <span class="n">chop</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">compare</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">ndtorch.propagate</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">fixed_point</span>
<span class="kn">from</span> <span class="nn">ndtorch.pfp</span> <span class="kn">import</span> <span class="n">parametric_fixed_point</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set data type and device</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="p">(</span><span class="n">qx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">qy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="n">qx</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">kq</span><span class="o">*</span><span class="n">qy</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span><span class="o">*</span><span class="n">qy</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">cy</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">slip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps between observation points</span>

<span class="k">def</span> <span class="nf">map_01_02</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">dkq</span><span class="p">):</span>
    <span class="n">cxsf1</span><span class="p">,</span> <span class="n">cxsd1</span><span class="p">,</span> <span class="n">cxsf2</span><span class="p">,</span> <span class="n">cxsd2</span><span class="p">,</span> <span class="n">cysf1</span><span class="p">,</span> <span class="n">cysd1</span><span class="p">,</span> <span class="n">cysf2</span><span class="p">,</span> <span class="n">cysd2</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">dkf</span><span class="p">,</span> <span class="n">dkd</span> <span class="o">=</span> <span class="n">dkq</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span> <span class="o">+</span> <span class="n">dkf</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cxsf1</span><span class="p">,</span> <span class="n">cysf1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">map_02_03</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">dkq</span><span class="p">):</span>
    <span class="n">cxsf1</span><span class="p">,</span> <span class="n">cxsd1</span><span class="p">,</span> <span class="n">cxsf2</span><span class="p">,</span> <span class="n">cxsd2</span><span class="p">,</span> <span class="n">cysf1</span><span class="p">,</span> <span class="n">cysd1</span><span class="p">,</span> <span class="n">cysf2</span><span class="p">,</span> <span class="n">cysd2</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">dkf</span><span class="p">,</span> <span class="n">dkd</span> <span class="o">=</span> <span class="n">dkq</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cxsd1</span><span class="p">,</span> <span class="n">cysd1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span> <span class="o">+</span> <span class="n">dkd</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">map_03_04</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">dkq</span><span class="p">):</span>
    <span class="n">cxsf1</span><span class="p">,</span> <span class="n">cxsd1</span><span class="p">,</span> <span class="n">cxsf2</span><span class="p">,</span> <span class="n">cxsd2</span><span class="p">,</span> <span class="n">cysf1</span><span class="p">,</span> <span class="n">cysd1</span><span class="p">,</span> <span class="n">cysf2</span><span class="p">,</span> <span class="n">cysd2</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">dkf</span><span class="p">,</span> <span class="n">dkd</span> <span class="o">=</span> <span class="n">dkq</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.21</span> <span class="o">+</span> <span class="n">dkd</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cxsd2</span><span class="p">,</span> <span class="n">cysd2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">map_04_05</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">dkq</span><span class="p">):</span>
    <span class="n">cxsf1</span><span class="p">,</span> <span class="n">cxsd1</span><span class="p">,</span> <span class="n">cxsf2</span><span class="p">,</span> <span class="n">cxsd2</span><span class="p">,</span> <span class="n">cysf1</span><span class="p">,</span> <span class="n">cysd1</span><span class="p">,</span> <span class="n">cysf2</span><span class="p">,</span> <span class="n">cysd2</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">dkf</span><span class="p">,</span> <span class="n">dkd</span> <span class="o">=</span> <span class="n">dkq</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">22.92</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">kick</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cxsf2</span><span class="p">,</span> <span class="n">cysf2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sext</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="mf">0.19</span> <span class="o">+</span> <span class="n">dkf</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">transport</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">map_01_02</span><span class="p">,</span>
    <span class="n">map_02_03</span><span class="p">,</span>
    <span class="n">map_03_04</span><span class="p">,</span>
    <span class="n">map_04_05</span>
<span class="p">]</span>

<span class="c1"># Define one-turn transport</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">dkq</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">dkq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set deviation variables</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">dkq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute fixed point</span>
<span class="c1"># Note, dynamical part is assumed to be fixed during optimization</span>

<span class="n">fp</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">dkq</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define parametric responce matrix</span>

<span class="k">def</span> <span class="nf">matrix</span><span class="p">(</span><span class="n">dkq</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pfp</span> <span class="o">=</span> <span class="n">parametric_fixed_point</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">fp</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">dkq</span><span class="p">),</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">)</span>
    <span class="n">chop</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">dqx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dqy</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">first</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">dqx</span><span class="p">,</span> <span class="n">dqy</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
        <span class="n">pfp</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pfp</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">dkq</span><span class="p">),</span>  <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">)</span>
        <span class="n">chop</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">dqx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dqy</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">first</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">dqx</span><span class="p">,</span> <span class="n">dqy</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>

<span class="n">matrix</span><span class="p">(</span><span class="n">dkq</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[7.582e+00, 5.939e+00, 7.582e+00, 5.939e+00, 0.000e+00, 0.000e+00, 0.000e+00, 0.000e+00],
        [6.220e+00, 4.041e+00, 6.753e+00, 4.568e+00, 0.000e+00, 0.000e+00, 0.000e+00, 0.000e+00],
        [5.113e+00, 2.612e+00, 5.113e+00, 2.612e+00, 0.000e+00, 0.000e+00, 0.000e+00, 0.000e+00],
        [6.753e+00, 4.568e+00, 6.220e+00, 4.041e+00, 0.000e+00, 0.000e+00, 0.000e+00, 0.000e+00],
        [7.582e+00, 5.939e+00, 7.582e+00, 5.939e+00, 0.000e+00, 0.000e+00, 0.000e+00, 0.000e+00],
        [0.000e+00, 0.000e+00, 0.000e+00, 0.000e+00, 1.348e+01, 2.164e+01, 1.348e+01, 2.164e+01],
        [0.000e+00, 0.000e+00, 0.000e+00, 0.000e+00, 1.806e+01, 2.752e+01, 1.854e+01, 2.800e+01],
        [0.000e+00, 0.000e+00, 0.000e+00, 0.000e+00, 2.516e+01, 3.677e+01, 2.516e+01, 3.677e+01],
        [0.000e+00, 0.000e+00, 0.000e+00, 0.000e+00, 1.854e+01, 2.800e+01, 1.806e+01, 2.752e+01],
        [0.000e+00, 0.000e+00, 0.000e+00, 0.000e+00, 1.348e+01, 2.164e+01, 1.348e+01, 2.164e+01]], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test responce matrix</span>

<span class="n">dc</span> <span class="o">=</span> <span class="mf">1.0E-3</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="n">o</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">fodo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dc</span><span class="p">,</span> <span class="n">dkq</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">os</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">qx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">o</span>
<span class="n">os</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transport</span><span class="p">:</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">dc</span><span class="p">,</span> <span class="n">dkq</span><span class="p">)</span>
    <span class="n">qx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">o</span>
    <span class="n">os</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">]))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">os</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">matrix</span><span class="p">(</span><span class="n">dkq</span><span class="p">)</span> <span class="o">@</span> <span class="n">dc</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set quadrupole errors</span>

<span class="n">ekq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Set measured responce matrix</span>

<span class="n">tag</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ekq</span><span class="p">)</span>

<span class="c1"># Set objective to minimize</span>

<span class="k">def</span> <span class="nf">obj</span><span class="p">(</span><span class="n">dkq</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">tag</span> <span class="o">-</span> <span class="n">matrix</span><span class="p">(</span><span class="n">dkq</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># Set model</span>

<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">knobs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knobs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">knobs</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knobs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform fit (adam)</span>

<span class="c1"># Set model instance</span>

<span class="n">mod</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ekq</span><span class="p">))</span>

<span class="c1"># Initial values of quadrupole amplitudes and objective function</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">knobs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">forward</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Set optimizer</span>

<span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1.0E-3</span><span class="p">)</span>

<span class="c1"># Perform optimization</span>

<span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">forward</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
    <span class="n">val</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

<span class="c1"># Final values of quadrupole amplitudes and objective function</span>
<span class="c1"># Compare with errors</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">knobs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">forward</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Plot error vs iteration</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Parameter containing:
tensor([0., 0.], dtype=torch.float64, requires_grad=True)
tensor(8.748e+00, dtype=torch.float64, grad_fn=&lt;SumBackward0&gt;)

Parameter containing:
tensor([-5.000e-03, 1.000e-03], dtype=torch.float64, requires_grad=True)
tensor(8.477e-11, dtype=torch.float64, grad_fn=&lt;SumBackward0&gt;)

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ndtorch_410_1.png" src="../_images/examples_ndtorch_410_1.png" />
</div>
</div>
</section>
<section id="Example-35:-ORM-optics-correction-(stochastic-objective)">
<h1>Example-35: ORM optics correction (stochastic objective)<a class="headerlink" href="#Example-35:-ORM-optics-correction-(stochastic-objective)" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../index.html" class="btn btn-neutral float-left" title="Welcome to ndtorch’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../modules/util.html" class="btn btn-neutral float-right" title="Util" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Ivan Morozov.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>